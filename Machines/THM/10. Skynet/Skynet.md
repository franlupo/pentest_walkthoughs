# HackPark

[TOC]

## Introduction

According to THM "This room will cover SQLi (exploiting this vulnerability manually and via SQLMap), cracking a users hashed password, using SSH tunnels to reveal a hidden service and using a metasploit payload to gain root privileges. ".

Let's get started!

## Service Scanning

After deploying the machine the first order of business would be performing a port scan on the target in order to check for active services.

```
nmap $ip
```

> PORT   STATE SERVICE
> 22/tcp open  ssh
> 80/tcp open  http
> MAC Address: 02:9E:47:DA:92:F5 (Unknown)
> 
> Nmap done: 1 IP address (1 host up) scanned in 1.76 seconds

We can see that the target has SSH and an HTTP open. Since we do not have credentials to log in via SSH, let us explore the web page.

We can navigate to the web server using http://$ip which showcases a game forum where users can login.

![image-20230228162112631](./images/image-20230228162112631.png)

By using inspect element we can download the image with the cartoon avatar holding a sniper and reverse image search in order to extract the name of this game protagonist.

![image-20230228162648815](./images/image-20230228162648815.png)

Great! We know have the name of the character.

![image-20230228162747531](./images/image-20230228162747531.png)

**Question** What is the name of the large cartoon avatar holding a sniper on the forum?

> Agent 47



## Obtain access via SQLi

THM gives us a hint that the login form is vulnerable to SQL injection. As such let us input a common SQL query which may let us bypass the login prompt.

> Username: ' or 1=1 -- -
>
> Password: a

![image-20230228163101116](./images/image-20230228163101116.png)

We were able to login and this proves that this vulnerability exists.

**Question** When you've logged in, what page do you get redirected to?

> portal.php

We can also verify that the search function is vulnerable to SQLi by using the same query. This will return all the game reviews.

![image-20230228170440979](./images/image-20230228170440979.png)

## Using SQLMap

We can use an automated tool such as SQLMap to dump the database. In order to do this we can save the request using BurpSuite (request.txt) and run:

```
sqlmap -r request.txt --dump
```

Initially I started by extracting the login the request endpoint and its body, select the vulnerable parameter try to dump the database with the following command:

```
sqlmap -u http://10.10.196.164/portal.php --data "searchitem=a" --dump
```

This method proved to work but was extremely slow. Hence, using the portal.php request is quicker and works the same way. 

The results showcase the existence of a **users** and **post** tables.

The posts table content is the one above. The users content is a single line containing a username id and a hashed password.

**Question** In the users table, what is the hashed password?

> Redacted

**Question** What was the username associated with the hashed password?

> Redacted

**Question** What was the other table name?

> post



## Cracking a password with JohnTheRipper

We can extract the password hash easily using CrackStation BUT we are going to use John the Ripper for this.

Now that we have a hashed password we need 2 things

1. What type of hash technique was used on the password
2. A wordlist to perform a dictionary attack

Using a tool such as hashid we can see that we are probably dealing with a password hashed with **sha256**.

Now let us choose a wordlist which will be the classic **rockyou.txt**.

Save the hash into a file and run the command below

```
john hash.txt --wordlist=/usr/share/wordlists/rockyou.txt --format=Raw-SHA256
```

Great! We now have both the username and the password in plaintext.

**Question** What is the de-hashed password?

> Redacted

What can we do with these credentials? Do you remeber that SSH port that was open on our initial nmap scan?

Let us try to login using SSH!

```
ssh <username>@ip
```

Great! We are in and we can read the content of the flag sitting in the current directory.

**Question** What is the user flag?

> Redacted



## Exposing services with reverse SSH tunnels

How this works is basically the target machine has a port that is being blocked via a firewall rule from the outside **which we later will check using the iptables command with root privileges**.

We can check this using the ss utility to investigate sockets running on the host.

```
ss -tulnp
```

The output of the command shows 5 TCP sockets and 2 UDP ones running.

**Question** How many TCP sockets are running?

> 5

How can we access the the service on port 10000? We can use an SSH tunnel for this by running the command below which will forward the traffic to our server so we can view it.

```
ssh -L <local port>:localhost:10000 <username>@<ip>
```

Great, now if we browse to http://localhost:9000 (example local port) we can see there is a CMS page.

![image-20230228181446418](./images/image-20230228181446418.png)

We can successfully login as the username and password we found at the begginning of the lab.

![image-20230228181520872](./images/image-20230228181520872.png)

**Question** What is the name of the exposed CMS?

> webmin

**Question** What is the CMS version?

> 1.580

Now that we have access to the CMS we were able to extract the software and its version.



## Privilege Escalation with Metasploit

Let us search using metasploit for vulnerabilities in webmin.

After a quick search we can identify the exploit `exploit/unix/webapp/webmin_show_cgi_exec` which sounds promising.

Setting up the exploit parameters has a little trick to it.

1. Choose payload `payload/cmd/unix/reverse`
2. Set RHOSTS and RPORT to localhost and 9000, since these are the ports which we are using to access the service as seen above on the browser, due to the SSH tunnel we created
3. Set LHOST and LPORT to our IP and for example 4444
4. Set username and password as the ones used to login to webmin
5. Set SSL to false (or you will get an error)
6. Exploit!

Now that we are root we can extract the root flag in /root/root.txt

**Question** What is the root flag?

> Redacted

Additionally if we use the command `iptables -S` this entry rejects incoming TCP traffic on port 10000 and sends a TCP RST (reset) packet back to the sender. Justifying how we could not scan or access port 10000.

```
-A INPUT -p tcp -m tcp --dport 10000 -j REJECT --reject-with tcp-reset
```



## Getting the content of the root flag without Metasploit

The description of the exploit states this

> This module exploits an arbitrary command execution vulnerability in Webmin 1.580. The vulnerability exists in the /file/show.cgi component and allows an authenticated user, with access to the File Manager Module, to execute arbitrary commands with root privileges. The module has been tested successfully with Webmin 1.580 over Ubuntu 10.04.

As an authenticated user, knowing where the root flag would be in we can access the file with root privileges and extract its content as showcased below.



![image-20230228182701935](./images/image-20230228182701935.png)
